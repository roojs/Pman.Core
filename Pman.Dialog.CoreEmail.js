//<script type="text/javascript">

// Auto generated file - created by app.Builder.js- do not edit directly (at present!)

Roo.namespace('Pman.Dialog');

Pman.Dialog.CoreEmail = {

 _strings : {
  'f31bbdd1b3e85bccd652680e16935819' :"Source",
  'f00a1d99f6f47917006e88a803ecde1f' :"Campaign",
  '2f26e35d61be90501e099089dc533638' :"Select Images",
  'e44b145bd8b49b06e0ad2ced1ad56466' :"Plain Text",
  '87d17f4624a514e81dc7c8e016a7405c' :"Mobile",
  'b357b524e740bc85b9790a0712d84a30' :"Email address",
  '962b90039a542a29cedd51d87a9f28a1' :"Html Editor",
  'f2a6c498fb90ee345d997f888fce3b18' :"Delete",
  '28690be026c0bb9003aa58e45e5662ca' :"Enabled - will be sent out",
  '754e1e134bc554a0af39749edbb59b9f' :"Job Title",
  '6a58f977f2b623b695a340766f2a6843' :"Select Project ",
  '8a38074d3c311563d2ebd05955ff4d19' :"Client of",
  '34d3f3e02279790a36c15a8f013ad426' :"Select Job Function",
  '51ce726b5887583d02d44df083c49ecc' :"Select Current Relationship",
  '69a696cc505197bd6b17c2f85b692faa' :"Direct Line",
  '21ec484b4de76650a90d349763586b01' :"Select Owner",
  'd41d8cd98f00b204e9800998ecf8427e' :" ",
  'b28cf7bd6a7d817ef920bc394ab49731' :"Select?",
  '31fde7b05ac8952dacf4af8a704074ec' :"Preview",
  'ea30b40c3caf28acb29198d20d243e54' :"Images / Attachments >>",
  '231bc72756b5e6de492aaaa1577f61b1' :"Remarks",
  '20eccd627374be9efeaa81e67c2e1443' :"Secondary Email",
  'b337c8a67244afb6551ee1f8f9717676' :"Test Class <BR/> (for system reference only)",
  'f8b41731930d0fb224210173cd5eff40' :"Primary Contact",
  'd7a278dd23696e10a4346c918891a82a' :"update MX",
  'f3017f202748e13d3554a15cbbd1b767' :"Refresh from Stripo",
  '4dba2e47f2f6bc2d0347e04dd44ecf9b' :"No mx records since",
  'e7b47c58815acf1d3afa59a84b5db7fb' :"Company Name",
  'b2902068bd468131aae5469000ead0f9' :"Displaying Notifications{0} - {1} of {2}",
  '67edd3b99247c9eb5884a02802a20fa7' :"Delivered",
  '9c9745a343efeacc9efe9b7222b27afb' :"Ref#",
  'de57d217310a391ad6c5f41d651ddae2' :"Send to test group",
  'ce8ae9da5b7cd6c3df2929543a9af92d' :"Email",
  'db530ec5680ef36a942d39c25043928d' :"Key Reference Notes",
  'c87d56de44398002b913008dac333ce7' :"Fails",
  '6f16a5f8ff5d75ab84c018adacdfcbb7' :"Field",
  '318e5e65b99bb99f6ec676ac53045808' :"No Notifications found",
  'ec211f7c20af43e742bf2570c3cb84f9' :"Add",
  '2393ad754ba179442d85e415d1d5167c' :"Displayorder",
  'ee3629f5936b16869c4687c79bab8e42' :"Delete Office",
  '1243daf593fa297e07ab03bf06d925af' :"Searching...",
  '66bc3ece76861852889e623217049d32' :"Edit Company Details",
  '5b8ef4e762c00a15a41cfc26dc3ef99c' :"Send me a test copy",
  'e9968623956c15023d54335ea3699855' :"Convert Html to Text",
  '6fa7053e67f9aca02815e903a655ef3d' :"Save & Send",
  '3a03f13c6360d706b597de533eadb22d' :"Honorific",
  'd41d8cd98f00b204e9800998ecf8427e' :"",
  '8a10310fb61d63d1711b319163eff1b1' :"Select email",
  'c7892ebbb139886662c6f2fc8c450710' :"Subject",
  '4da9ac510e44c4852d1290ab76b985a8' :"Key Decision Maker",
  'ee7dad31fea478292f8e2dd24133c6a9' :"Personal Details",
  'acdc0b2d908229fb89cfa39c25c8442f' :"Job Function",
  '96fdac283668b2490c859ef6ea97c86e' :"Owner of this record",
  '5b7d0fb4422f6d5854b9827293ece5ea' :"Sent Date",
  '396ecabf0cd1f9503e591418851ef406' :"Edit / Create Message",
  '777171b4509a74cdb3ad40069c584d02' :"Select a Source",
  '01c3c4d5f15312f6c0ae7913eb54e1d9' :"WeChat ID",
  'df814135652a5a308fea15bff37ea284' :"Office",
  'e5d579ff9d4caf59887ae80dff261acf' :"First Meeting Notes",
  '0736d73357df264e67d36a66b519122d' :"Add Office",
  '054c93063db5b62b23b48ef801f27aa0' :"Phone numbers",
  'b9c49611cfda3259a2b837b39489e650' :"Add Image",
  '6c768695a8efb18436d5b7b4374cdb45' :"Select core_enum",
  '70012379217db5897b48b958401effc3' :"Is Spammer",
  'ea4788705e6873b424c65e91c2846b19' :"Cancel",
  '68b00d723d37122f64da8d9939f836f0' :"BCC Group",
  'fad695291417e5155ae516f699edefa1' :"Locations Covered/Targeted",
  'c4ca4238a0b923820dcc509a6f75849b' :"1",
  '90bfdc4085f24f340d732886ca10e1a0' :"Blog Website",
  '4994a8ffeba4ac3140beb89e8d41f174' :"Language",
  '6d222e766779a92d741327ef936686c0' :"Spoken Language",
  'dd7bf230fde8d4836917806aff6a6b27' :"Address",
  'b20a8b77b05d53b4e695738731400c85' :"Mailout Name",
  '2c466a2c159463f1d9ef5a7b57b52827' :"Select BCC Group",
  'bd88a20b53a47f7b5704a83a15ff5506' :"Saved Version",
  '5da618e8e4b89c66fe86e32cdafde142' :"From",
  '751d204230c22fb929f7feb90884a959' :"Twitter handle",
  'b78a3223503896721cca1303f776159b' :"Title",
  '6f54043edff88231017ffe8a1f092f44' :"Contact Details",
  '16d2b386b2034b9488996466aaae0b57' :"History",
  '844cb2d0c0304fd7df39b2f522c8c5cc' :"Current Relationship",
  '0de4afdad57ed10d2663be2f84481601' :"Ownership",
  '4fd0a37b0a02153b23bbb61d7915a429' :"Industry",
  '10ffcae93e0ef4941193179b3b2f2d6a' :"<div class=\"x-grid-cell-text x-btn button\">{pressrelease_id:this.formatPR}{name:this.formatName} </div>",
  '0d41a61d4678361579ed786ea1a15772' :"AutoFile?",
  '15bbb9d0bbf25e8d2978de1168c749dc' :"Website",
  'f789853b5a3d39a56a2fb59b0892b598' :"Is Action Required?",
  'e884c507c5198a4578a84498f7a323e2' :"LinkedIn",
  '6d2b3c608551bf2a38dc0c8b6cb298bc' :"Always File Messages from this Person in Project",
  'bc910f8bdf70f29374f496f05be0330c' :"First Name",
  '6b7d38bed7d958f7e63e32157910c6b2' :"For my eyes only",
  '38be0abb8dcd2feda6d12b0f0cfb553d' :"Business Focus",
  '308f2757bfc9ce92fb00ff93fdffd279' :"Images / Attachments",
  '1351017ac6423911223bc19a8cb7c653' :"Filename",
  'c9cc8cce247e49bae79f15173ce97354' :"Save",
  'b79f8efa60d31fefaae5e9aaaf3b2e70' :"Un-subscribed",
  '4c2a8fe7eaf24721cc7a9f0175115bd4' :"Message",
  '1814dfa23ca67a5b93237922728b52e3' :"Company Type",
  '5feb9bf3c03b32635135006cbacb9542' :"Insert Field",
  'a2fa78bdc038a0a1df5caff2ac1ad945' :"Who owns this record",
  '86266ee937d97f812a8e57d22b62ee29' :"reset",
  'fff0d600f8a0b5e19e88bfb821dd1157' :"Images",
  'ded4cba1b04eb8236e24a3e39470d8a7' :"Select Campaign",
  'a3e4f4667d88fd6ee4604cebc8d34255' :"Contact Status",
  'be649b4ca625c123850b1d9125753d7c' :"Spam Status",
  '9b7ac356a686920f9f832ebd7d94997c' :"Project Filing",
  '77587239bf4c54ea493c7033e1dbf636' :"Last Name"
 },
 _named_strings : {
  'url_value' : 'd41d8cd98f00b204e9800998ecf8427e' /*  */ ,
  'bcc_group_id_name_fieldLabel' : '68b00d723d37122f64da8d9939f836f0' /* BCC Group */ ,
  'crm_client_of_competitor_fieldLabel' : '8a38074d3c311563d2ebd05955ff4d19' /* Client of */ ,
  'project_id_fs_boxLabel' : '6d2b3c608551bf2a38dc0c8b6cb298bc' /* Always File Messages from this Person in Project */ ,
  'subject_fieldLabel' : 'c7892ebbb139886662c6f2fc8c450710' /* Subject */ ,
  'crm_is_private_fieldLabel' : '6b7d38bed7d958f7e63e32157910c6b2' /* For my eyes only */ ,
  'email_is_spam_fieldLabel' : '70012379217db5897b48b958401effc3' /* Is Spammer */ ,
  'domain_id_no_mx_dt_fieldLabel' : '4dba2e47f2f6bc2d0347e04dd44ecf9b' /* No mx records since */ ,
  'crm_role_function_id_display_name_emptyText' : '34d3f3e02279790a36c15a8f013ad426' /* Select Job Function */ ,
  'office_phone_fieldLabel' : 'df814135652a5a308fea15bff37ea284' /* Office */ ,
  'active_value' : 'c4ca4238a0b923820dcc509a6f75849b' /* 1 */ ,
  'crm_role_function_id_display_name_qtip' : '34d3f3e02279790a36c15a8f013ad426' /* Select Job Function */ ,
  'phone_mobile_fieldLabel' : '87d17f4624a514e81dc7c8e016a7405c' /* Mobile */ ,
  'crm_source_id_display_name_loadingText' : '1243daf593fa297e07ab03bf06d925af' /* Searching... */ ,
  'email_fails_fieldLabel' : 'c87d56de44398002b913008dac333ce7' /* Fails */ ,
  'crm_business_focus_fieldLabel' : '38be0abb8dcd2feda6d12b0f0cfb553d' /* Business Focus */ ,
  'crm_source_id_display_name_emptyText' : '777171b4509a74cdb3ad40069c584d02' /* Select a Source */ ,
  'lang_name_fieldLabel' : '6d222e766779a92d741327ef936686c0' /* Spoken Language */ ,
  'crm_current_relationship_id_display_name_qtip' : '51ce726b5887583d02d44df083c49ecc' /* Select Current Relationship */ ,
  'active_boxLabel' : '28690be026c0bb9003aa58e45e5662ca' /* Enabled - will be sent out */ ,
  'honor_loadingText' : '1243daf593fa297e07ab03bf06d925af' /* Searching... */ ,
  'comptype_id_display_name_value' : 'd41d8cd98f00b204e9800998ecf8427e' /*  */ ,
  'test_class_fieldLabel' : 'b337c8a67244afb6551ee1f8f9717676' /* Test Class <BR/> (for system reference only) */ ,
  'phone_direct_fieldLabel' : '69a696cc505197bd6b17c2f85b692faa' /* Direct Line */ ,
  'name_qtip' : '6c768695a8efb18436d5b7b4374cdb45' /* Select core_enum */ ,
  'crm_industry_id_display_name_value' : 'd41d8cd98f00b204e9800998ecf8427e' /*  */ ,
  'from_email_combo_fieldLabel' : 'b357b524e740bc85b9790a0712d84a30' /* Email address */ ,
  'crm_is_primary_contact_fieldLabel' : 'f8b41731930d0fb224210173cd5eff40' /* Primary Contact */ ,
  'owner_id_name_emptyText' : '21ec484b4de76650a90d349763586b01' /* Select Owner */ ,
  'project_id_name_qtip' : '6a58f977f2b623b695a340766f2a6843' /* Select Project  */ ,
  'crm_current_relationship_id_display_name_emptyText' : '51ce726b5887583d02d44df083c49ecc' /* Select Current Relationship */ ,
  'meeting_notes_fieldLabel' : 'e5d579ff9d4caf59887ae80dff261acf' /* First Meeting Notes */ ,
  'from_email_combo_qtip' : 'ce8ae9da5b7cd6c3df2929543a9af92d' /* Email */ ,
  'crm_source_id_display_name_qtip' : '777171b4509a74cdb3ad40069c584d02' /* Select a Source */ ,
  'firstname_fieldLabel' : 'bc910f8bdf70f29374f496f05be0330c' /* First Name */ ,
  'url_linkedin_fieldLabel' : 'e884c507c5198a4578a84498f7a323e2' /* LinkedIn */ ,
  'crm_current_relationship_id_display_name_fieldLabel' : '844cb2d0c0304fd7df39b2f522c8c5cc' /* Current Relationship */ ,
  'url_fieldLabel' : '15bbb9d0bbf25e8d2978de1168c749dc' /* Website */ ,
  'comptype_id_display_name_fieldLabel' : '1814dfa23ca67a5b93237922728b52e3' /* Company Type */ ,
  'crm_client_of_competitor_value' : 'd41d8cd98f00b204e9800998ecf8427e' /*  */ ,
  'from_email_combo_emptyText' : '8a10310fb61d63d1711b319163eff1b1' /* Select email */ ,
  'crm_role_function_id_display_name_fieldLabel' : 'acdc0b2d908229fb89cfa39c25c8442f' /* Job Function */ ,
  'crm_is_decision_maker_fieldLabel' : '4da9ac510e44c4852d1290ab76b985a8' /* Key Decision Maker */ ,
  'email_fieldLabel' : 'ce8ae9da5b7cd6c3df2929543a9af92d' /* Email */ ,
  'wechat_id_fieldLabel' : '01c3c4d5f15312f6c0ae7913eb54e1d9' /* WeChat ID */ ,
  'language_name_fieldLabel' : '4994a8ffeba4ac3140beb89e8d41f174' /* Language */ ,
  'project_id_fs_fieldLabel' : '0d41a61d4678361579ed786ea1a15772' /* AutoFile? */ ,
  'lang_name_qtip' : '6c768695a8efb18436d5b7b4374cdb45' /* Select core_enum */ ,
  'project_id_name_emptyText' : 'ded4cba1b04eb8236e24a3e39470d8a7' /* Select Campaign */ ,
  'alt_email_fieldLabel' : '20eccd627374be9efeaa81e67c2e1443' /* Secondary Email */ ,
  'bcc_group_id_name_qtip' : '2c466a2c159463f1d9ef5a7b57b52827' /* Select BCC Group */ ,
  'owner_id_name_qtip' : 'a2fa78bdc038a0a1df5caff2ac1ad945' /* Who owns this record */ ,
  'crm_source_id_display_name_fieldLabel' : 'f31bbdd1b3e85bccd652680e16935819' /* Source */ ,
  'lang_name_loadingText' : '1243daf593fa297e07ab03bf06d925af' /* Searching... */ ,
  'remarks_fieldLabel' : 'db530ec5680ef36a942d39c25043928d' /* Key Reference Notes */ ,
  'from_email_text_fieldLabel' : 'b357b524e740bc85b9790a0712d84a30' /* Email address */ ,
  'bcc_group_id_name_loadingText' : '1243daf593fa297e07ab03bf06d925af' /* Searching... */ ,
  'role_fieldLabel' : '754e1e134bc554a0af39749edbb59b9f' /* Job Title */ ,
  'crm_current_relationship_id_display_name_loadingText' : '1243daf593fa297e07ab03bf06d925af' /* Searching... */ ,
  'from_name_fieldLabel' : '5da618e8e4b89c66fe86e32cdafde142' /* From */ ,
  'bcc_group_id_name_emptyText' : '2c466a2c159463f1d9ef5a7b57b52827' /* Select BCC Group */ ,
  'crm_role_function_id_display_name_loadingText' : '1243daf593fa297e07ab03bf06d925af' /* Searching... */ ,
  'honor_fieldLabel' : '3a03f13c6360d706b597de533eadb22d' /* Honorific */ ,
  'url_blog_fieldLabel' : '90bfdc4085f24f340d732886ca10e1a0' /* Blog Website */ ,
  'crm_is_unsubscribed_fieldLabel' : 'b79f8efa60d31fefaae5e9aaaf3b2e70' /* Un-subscribed */ ,
  'url_twitter_fieldLabel' : '751d204230c22fb929f7feb90884a959' /* Twitter handle */ ,
  'project_id_name_loadingText' : '1243daf593fa297e07ab03bf06d925af' /* Searching... */ ,
  'is_action_required_fieldLabel' : 'f789853b5a3d39a56a2fb59b0892b598' /* Is Action Required? */ ,
  'owner_id_name_fieldLabel' : '96fdac283668b2490c859ef6ea97c86e' /* Owner of this record */ ,
  'crm_industry_id_display_name_fieldLabel' : '4fd0a37b0a02153b23bbb61d7915a429' /* Industry */ ,
  'crm_business_focus_value' : 'd41d8cd98f00b204e9800998ecf8427e' /*  */ ,
  'crm_location_covered_display_name_fieldLabel' : 'fad695291417e5155ae516f699edefa1' /* Locations Covered/Targeted */ ,
  'owner_id_name_loadingText' : '1243daf593fa297e07ab03bf06d925af' /* Searching... */ ,
  'from_email_combo_loadingText' : '1243daf593fa297e07ab03bf06d925af' /* Searching... */ ,
  'project_id_name_fieldLabel' : 'f00a1d99f6f47917006e88a803ecde1f' /* Campaign */ ,
  'lastname_fieldLabel' : '77587239bf4c54ea493c7033e1dbf636' /* Last Name */ ,
  'name_fieldLabel' : 'b20a8b77b05d53b4e695738731400c85' /* Mailout Name */ ,
  'name_loadingText' : '1243daf593fa297e07ab03bf06d925af' /* Searching... */ 
 },

 dialog : false,
 callback:  false,

 show : function(data, cb)
 {
  if (!this.dialog) {
   this.create();
  }

  this.callback = cb;
  this.data = data;
  this.dialog.show.apply(this.dialog,  Array.prototype.slice.call(arguments).slice(2));
  if (this.form) {
   this.form.reset();
   this.form.setValues(data);
   this.form.fireEvent('actioncomplete', this.form,  { type: 'setdata', data: data });
  }

 },

 create : function()
 {
   var _this = this;
   this.dialog = Roo.factory({
    xtype : 'LayoutDialog',
    closable : true,
    collapsible : false,
    height : 500,
    modal : true,
    resizable : true,
    title : _this._strings['396ecabf0cd1f9503e591418851ef406'] /* Edit / Create Message */,
    width : 800,
    listeners : {
     show : function (_self)
      {
          _self.layout.getRegion('center').showPanel(0);
          var w = Roo.lib.Dom.getViewWidth();
          var h = Roo.lib.Dom.getViewHeight();        this.resizeTo(w-50, h-50);
          this.center();    
          var ew = Math.max(250, w-320);
          var eh = Math.max(250, h-350) ;
          var e = _this.dialog.layout.getRegion('east');
          if (e.visible) {
              e.hide();
          }
          
          var el = _self.getEl();
          var elw = el.dom.clientWidth;
          
          var bdtext = _this.form.findField('bodytext');
          var ptext = _this.form.findField('plaintext');
          if(bdtext.resizeEl){
              bdtext.width = elw-100;
              bdtext.resizeEl.resizeTo.defer(110, bdtext.resizeEl,[ bdtext.width, bdtext.height  ] );
              ptext.setSize(bdtext.width , bdtext.height);
          }
          
      }
    },
    xns : Roo,
    '|xns' : 'Roo',
    center : {
     xtype : 'LayoutRegion',
     tabPosition : 'top',
     xns : Roo,
     '|xns' : 'Roo'
    },
    east : {
     xtype : 'LayoutRegion',
     hidden : true,
     split : true,
     title : _this._strings['308f2757bfc9ce92fb00ff93fdffd279'] /* Images / Attachments */,
     titlebar : true,
     width : 500,
     xns : Roo,
     '|xns' : 'Roo'
    },
    buttons : [
     {
      xtype : 'Button',
      text : _this._strings['ea4788705e6873b424c65e91c2846b19'] /* Cancel */,
      listeners : {
       click : function (_self, e)
        {
            _this.dialog.hide();
            if (_this.callback) {
                _this.callback.call(_this, _this.data);
            }
            _this.form.reset();
        }
      },
      xns : Roo,
      '|xns' : 'Roo'
     },
     {
      xtype : 'Button',
      text : _this._strings['c9cc8cce247e49bae79f15173ce97354'] /* Save */,
      listeners : {
       click : function (_self, e)
        {
        
            // do some checks?
            _this.form.preValidate(function(res) {
                if (!res) {
                    return; //failed.
                }
                 _this.form.doAction("submit");
            });
        
        },
       render : function (_self)
        {
            _this.saveBtn = this;
        }
      },
      xns : Roo,
      '|xns' : 'Roo'
     },
     {
      xtype : 'Button',
      text : _this._strings['6fa7053e67f9aca02815e903a655ef3d'] /* Save & Send */,
      listeners : {
       click : function (_self, e)
        {
            
            _this.form.preValidate(function(res) {
                if (!res) {
                    return; //failed.
                }
                
                _this.saveAndSend = true;
                _this.form.doAction("submit");
            });
        
            
        },
       render : function (_self)
        {
            _this.sendBtn = this;
        }
      },
      xns : Roo,
      '|xns' : 'Roo'
     },
     {
      xtype : 'Button',
      text : _this._strings['de57d217310a391ad6c5f41d651ddae2'] /* Send to test group */,
      listeners : {
       click : function (_self, e)
        {
            
            _this.form.preValidate(function(res) {
                if (!res) {
                    return; //failed.
                }
                
                _this.sendTest = true;
                _this.form.doAction("submit");
            });
        
            
        },
       render : function (_self)
        {
            _this.sendTestBtn = this;
        }
      },
      xns : Roo,
      '|xns' : 'Roo'
     }
    ],
    items  : [
     {
      xtype : 'NestedLayoutPanel',
      background : false,
      region : 'center',
      title : _this._strings['4c2a8fe7eaf24721cc7a9f0175115bd4'] /* Message */,
      xns : Roo,
      '|xns' : 'Roo',
      layout : {
       xtype : 'BorderLayout',
       xns : Roo,
       '|xns' : 'Roo',
       center : {
        xtype : 'LayoutRegion',
        xns : Roo,
        '|xns' : 'Roo'
       },
       east : {
        xtype : 'LayoutRegion',
        width : 380,
        xns : Roo,
        '|xns' : 'Roo'
       },
       items  : [
        {
         xtype : 'ContentPanel',
         autoScroll : true,
         fitToFrame : true,
         region : 'center',
         xns : Roo,
         '|xns' : 'Roo',
         items  : [
          {
           xtype : 'Form',
           labelAlign : 'right',
           labelWidth : 120,
           method : 'POST',
           style : 'margin:10px;',
           url : baseURL + '/Roo/Crm_person.php',
           validEmail : function() {
           
               //var vtype = 'email';
               var allowBlank = false;
               var email_fails = 0;
               
               // allow blank email if contact is not empty
               if(_this.form.findField('office_phone').getValue()){
                   //vtype = '';
                   allowBlank = true;
                   if(!_this.form.findField('email').getValue()) {
                       email_fails = 10;
                   }
               }
               
               //_this.emailField.vtype = vtype;
               _this.emailField.allowBlank = allowBlank;
               _this.emailField.validate();
               _this.form.findField('email_fails').setValue(email_fails);
               
               // keep original email fails if no email change
               if(_this.form.findField('email').getValue() == _this.data.email) {
                   _this.form.findField('email_fails').setValue(_this.data.email_fails);
               }
           },
           listeners : {
            actioncomplete : function(_self,action)
             {
                 if (action.type == 'setdata') {
                     _this.dialog.layout.showPanel(0);
                     
                     this.findField('meeting_notes').hide();
                     _this.form.findField('crm_is_private').actionMode = 'fieldEl';
                     _this.form.findField('crm_is_private').show();
                     _this.noMxRow.hide();
             
                    if(_this.data.id > 0){
                         if(_this.data.owner_id != Pman.Login.authUserId){
                             _this.form.findField('crm_is_private').hide();
                         }
                        this.load({ method: 'GET', params: { '_id' : _this.data.id, '_notes' : 1, '_with_enquiry': 1}});
                    }else{
                         this.findField('meeting_notes').show();
             
                         if(_this.form.findField('company_id').getValue() > 0){
                             _this.cform.fireEvent('actioncomplete', _this.form,  { type: 'setdata', data: {company_id : _this.form.findField('company_id').getValue()} });
                         }
                         if (typeof(_this.data._show_project) != 'undefined') {
                             _this.project.show();
                         }
                    }
                    _this.ownerSet.hide();
                    return;
                 }
                 
                 if (action.type == 'load') {
                     _this.dialog.el.unmask();
                     _this.data = action.result.data;
                     if(
                         // unassigned contacts
                         !(_this.data.owner_id * 1) &&
                         // cannot edit if the staff doesn't have the edit permission 'Crm.View_Unassigned_Contacts'
                         !Pman.hasPerm('Crm.View_Unassigned_Contacts', 'E')
                         ||
                         // current staff's contacts
                         _this.data.owner_id * 1 && _this.data.owner_id != Pman.Login.authUser.id && _this.data.owner_id_active * 1 && 
                         // cannot edit if the staff doesn't have the edit permission 'Crm.View_Other_Contacts'
                         !Pman.hasPerm('Crm.View_Other_Contacts', 'E')
                         ||
                         // old staff's contacts
                         _this.data.owner_id * 1 && _this.data.owner_id != Pman.Login.authUser.id && !(_this.data.owner_id_active * 1) &&
                         // cannot edit if the staff has none of the edit permissions ('Crm.View_Other_Contacts' or 'Crm.View_Unassigned_Contacts')
                         !Pman.hasPerm('Crm.View_Unassigned_Contacts', 'E') && !Pman.hasPerm('Crm.View_Other_Contacts', 'E')
                     ) {
                         // hide
                         _this.dialog.el.unmask();
                         _this.dialog.hide();
                         _this.grid.ds.removeAll();
                         _this.form.reset();
                         _this.cform.reset();
                         if (_this.callback) {
                             _this.callback.call(_this, action.result.data);
                         }
                         Roo.MessageBox.alert('Error', "You don't have the permission to edit this contact");
                         return;
                     }
                     _this.ownerSet.hide();
                     // if owner is not active or changeowner perm
                     if (_this.data.owner_id_active * 1 < 1 || Pman.hasPerm('Crm.ChangeOwner','S')) {
                         _this.ownerSet.show();
                     }
                     if (_this.data.owner_id_active * 1 < 1) {
                         (function() {Roo.MessageBox.alert("Notice", 
                             "The Current Owner of this record is no longer active, you should change the ownership before Saving"
                         );}).defer(1000);
                     }
                     
                     
                     _this.form.validEmail();
                     
                     if(_this.form.findField('company_id').getValue() > 0){
                         _this.cform.fireEvent('actioncomplete', _this.form,  { type: 'setdata', data: {company_id : action.result.data.company_id} });
                     }
                     
                     if(typeof(_this.data.crm_location_covered_name) != 'undefined'){
                         var c =Roo.decode(_this.data.crm_location_covered_name);
                         _this.form.findField('crm_location_covered').setValue(c);
                     }
                     
                     if(action.result.data){
                         var data = action.result.data;
                     
                         var pAry = action.result.data.phone.split("+");
                         if(pAry.length < 1){
                             return;
                         }
                         _this.form.findField('office_phone').setValue(pAry[0]);
                         Roo.log(pAry);
                         if(pAry.length > 1){
                             _this.form.findField('ext').setValue(pAry[1]);
                         }
                         // fill in the name if not set..
                         if (!data.firstname.length && !data.lastname.length && data.name.length) {
                             var ar = data.name.split(/\s+/);
                             _this.form.findField('firstname').setValue(ar.shift());
                             _this.form.findField('lastname').setValue(ar.join(' '));
                         }
                         
                         
                         /*
                         
                         _this.form.findField('office_phone').el.on('click', function(){
                             var rowIndex = null;
                             Roo.each(_this.grid.ds.data.items, function(r,k){
                                 Roo.log(r);
                                 if(r.data.has_selected) rowIndex = k;
                             });
                             Roo.log('index?');
                             Roo.log(rowIndex);
                             if(rowIndex === null){
                                 Roo.MessageBox.alert('', 'Please select an office');
                             }
                             Pman.Dialog.CrmOffice.show( _this.grid.ds.getAt(rowIndex).data, function() {
                                _this.grid.ds.load({});
                             }); 
                         });
                         */
                     }
                     
                     _this.form.findField('lang').setFromData({
                         code: _this.data.lang,
                         title: Pman.I18n.toName('l', _this.data.lang)
                     });
                     
                     var no_mx_dt = _this.form.findField('domain_id_no_mx_dt').value;
                     
                     var ret = no_mx_dt instanceof Date ? no_mx_dt.format('Y-m-d H:i:s') : no_mx_dt;
                     
                     if(ret !== '1000-01-01 00:00:00') {
                         _this.noMxRow.show();
                     }
                     
                     return;
                 }
                 if (action.type =='submit') {
                     // it's a contact with enquiry
                     if(_this.form.findField('enquiry_id').getValue() * 1) {
                         var enquiryId = _this.form.findField('enquiry_id').getValue() * 1;
                         Roo.MessageBox.show({
                             title: "Follow up",
                             msg: "Do the sales staff need to follow up on it?",
                             buttons : {yes: "Yes", no: "No"},
                             fn : function(r) {
                                 // reset contact_again_notify_id
                                 new Pman.Request({
                                     method: 'POST',
                                     url: baseURL + '/Roo/Crm_action',
                                     mask: 'Clearing enquiries',
                                     params: {
                                         _clear_person_enquiry: action.result.data.id,
                                         notes: 'Assigned to ' + action.result.data.owner_id_name
                                     },
                                     success: function() {
                                         // need follow up
                                         if (r == 'yes') {
                                             // add a first meeting notes
                                             // assigned to the owner
                                             var param = {
                                                 person_id : action.result.data.id,
                                                 action_type_id_name: 'FIRSTMEETING',
                                                 company_id: action.result.data.company_id,
                                                 owner_id: action.result.data.owner_id,
                                                 owner_id_active: action.result.data.owner_id_active,
                                                 owner_id_name: action.result.data.owner_id_name
                                             };
                                             
                                             Pman.Dialog.CrmAction.show(param , function() {
                                                 if (_this.callback) {
                                                     _this.callback.call(_this, action.result.data);
                                                 }
                                             });
                                         }
                                         // no follow up
                                         else {
                                             if (_this.callback) {
                                                 _this.callback.call(_this, action.result.data);
                                             }
                                         }
                                     }
                                 });
                             }
                             
                         });
                     }
                     else {
                         if (_this.callback) {
                             _this.callback.call(_this, action.result.data);
                          }
                     }
                     _this.dialog.el.unmask();
                     _this.dialog.hide();
                     _this.grid.ds.removeAll();
                     _this.form.reset();
                     _this.cform.reset();
                     return;
                 }
             },
            actionfailed : function (_self, action)
             {
                 _this.dialog.el.unmask();
                 if(action.failureType == 'server'){
                     if(action.result.code == 'NOTICE-DUPLICATE-EMAIL-UNASSIGNED') {
                         Roo.Msg.show({
                             title: 'Warning',
                             msg: action.result.errorMsg,
                             buttons: {yes: true, no: true},
                             fn: function(res) {
                                 if(res == 'yes') {
                                     new Pman.Request({
                                         url : baseURL + '/Roo/Crm_person.php',
                                         method : 'POST',
                                         params : {
                                           id : action.result.errors.person_id,
                                           owner_id : Pman.Login.authUser.id
                                         }, 
                                         success : function(res) {
                                             _this.form.load({ method: 'GET', params: { '_id' : action.result.errors.person_id, '_notes' : 1}});
                                         }
                                     });
                                     return;
                                 }
                             }
                         });
                         return;
                     }
                     Roo.MessageBox.alert('Error', action.result.errorMsg);
                     return;
                 }
                 Roo.MessageBox.alert('Error', 'fix all the errors in red');
             },
            rendered : function (form)
             {
                 _this.form= form;
                 
                
                 
             }
           },
           xns : Roo.form,
           '|xns' : 'Roo.form',
           items  : [
            {
             xtype : 'FieldSet',
             legend : _this._strings['ee7dad31fea478292f8e2dd24133c6a9'] /* Personal Details */,
             xns : Roo.form,
             '|xns' : 'Roo.form',
             items  : [
              {
               xtype : 'Row',
               width : 420,
               xns : Roo.form,
               '|xns' : 'Roo.form',
               items  : [
                {
                 xtype : 'Column',
                 labelWidth : 140,
                 width : 180,
                 xns : Roo.form,
                 '|xns' : 'Roo.form',
                 items  : [
                  {
                   xtype : 'Checkbox',
                   fieldLabel : _this._strings['b79f8efa60d31fefaae5e9aaaf3b2e70'] /* Un-subscribed */,
                   name : 'crm_is_unsubscribed',
                   width : 150,
                   xns : Roo.form,
                   '|xns' : 'Roo.form'
                  }
                 ]
                },
                {
                 xtype : 'Column',
                 labelWidth : 140,
                 width : 200,
                 xns : Roo.form,
                 '|xns' : 'Roo.form',
                 items  : [
                  {
                   xtype : 'Checkbox',
                   fieldLabel : _this._strings['6b7d38bed7d958f7e63e32157910c6b2'] /* For my eyes only */,
                   name : 'crm_is_private',
                   width : 200,
                   xns : Roo.form,
                   '|xns' : 'Roo.form'
                  }
                 ]
                }
               ]
              },
              {
               xtype : 'Row',
               width : 420,
               xns : Roo.form,
               '|xns' : 'Roo.form',
               items  : [
                {
                 xtype : 'Column',
                 labelWidth : 140,
                 width : 400,
                 xns : Roo.form,
                 '|xns' : 'Roo.form',
                 items  : [
                  {
                   xtype : 'ComboBox',
                   allowBlank : true,
                   displayField : 'val',
                   editable : false,
                   fieldLabel : _this._strings['3a03f13c6360d706b597de533eadb22d'] /* Honorific */,
                   forceSelection : false,
                   listWidth : 200,
                   loadingText : _this._strings['1243daf593fa297e07ab03bf06d925af'] /* Searching... */,
                   mode : 'local',
                   name : 'honor',
                   selectOnFocus : false,
                   tpl : '<div class=\"x-grid-cell-text x-btn button\"><b>{val}</b> </div>',
                   triggerAction : 'all',
                   typeAhead : true,
                   valueField : 'type',
                   width : 100,
                   xns : Roo.form,
                   '|xns' : 'Roo.form',
                   store : {
                    xtype : 'SimpleStore',
                    data : [ 
                        [ 'Mr' ],
                        [ 'Mrs' ],
                        [ 'Ms' ]
                    ],
                    fields : [ 'val'],
                    xns : Roo.data,
                    '|xns' : 'Roo.data'
                   }
                  }
                 ]
                }
               ]
              },
              {
               xtype : 'Row',
               width : 420,
               xns : Roo.form,
               '|xns' : 'Roo.form',
               items  : [
                {
                 xtype : 'Column',
                 labelWidth : 140,
                 width : 400,
                 xns : Roo.form,
                 '|xns' : 'Roo.form',
                 items  : [
                  {
                   xtype : 'TextField',
                   allowBlank : false,
                   fieldLabel : _this._strings['bc910f8bdf70f29374f496f05be0330c'] /* First Name */,
                   name : 'firstname',
                   width : 200,
                   xns : Roo.form,
                   '|xns' : 'Roo.form'
                  },
                  {
                   xtype : 'TextField',
                   allowBlank : false,
                   fieldLabel : _this._strings['77587239bf4c54ea493c7033e1dbf636'] /* Last Name */,
                   name : 'lastname',
                   width : 200,
                   xns : Roo.form,
                   '|xns' : 'Roo.form'
                  },
                  {
                   xtype : 'TextField',
                   fieldLabel : _this._strings['754e1e134bc554a0af39749edbb59b9f'] /* Job Title */,
                   name : 'role',
                   width : 200,
                   xns : Roo.form,
                   '|xns' : 'Roo.form'
                  },
                  {
                   xtype : 'ComboBox',
                   allowBlank : true,
                   alwaysQuery : true,
                   displayField : 'display_name',
                   editable : true,
                   emptyText : _this._strings['34d3f3e02279790a36c15a8f013ad426'] /* Select Job Function */,
                   fieldLabel : _this._strings['acdc0b2d908229fb89cfa39c25c8442f'] /* Job Function */,
                   forceSelection : true,
                   hiddenName : 'crm_role_function_id',
                   listWidth : 400,
                   loadingText : _this._strings['1243daf593fa297e07ab03bf06d925af'] /* Searching... */,
                   minChars : 1,
                   name : 'crm_role_function_id_display_name',
                   pageSize : 20,
                   qtip : _this._strings['34d3f3e02279790a36c15a8f013ad426'] /* Select Job Function */,
                   queryParam : 'search[display_name]',
                   selectOnFocus : true,
                   tpl : '<div class=\"x-grid-cell-text x-btn button\"><b>{display_name}</b> </div>',
                   triggerAction : 'all',
                   typeAhead : false,
                   valueField : 'id',
                   width : 200,
                   listeners : {
                    add : function (combo)
                     {
                         Pman.Dialog.CrmJobFunction.show({id:0});
                     }
                   },
                   xns : Roo.form,
                   '|xns' : 'Roo.form',
                   store : {
                    xtype : 'Store',
                    remoteSort : true,
                    sortInfo : { direction : 'ASC', field: 'display_name' },
                    listeners : {
                     beforeload : function (_self, o){
                          o.params = o.params || {};
                          // set more here
                          o.params.etype = 'crm_role_function';
                          o.params.active  = 1;
                      }
                    },
                    xns : Roo.data,
                    '|xns' : 'Roo.data',
                    proxy : {
                     xtype : 'HttpProxy',
                     method : 'GET',
                     url : baseURL + '/Roo/core_enum.php',
                     xns : Roo.data,
                     '|xns' : 'Roo.data'
                    },
                    reader : {
                     xtype : 'JsonReader',
                     fields : [{"name":"id","type":"int"},{"name":"etype","type":"string"}],
                     id : 'id',
                     root : 'data',
                     totalProperty : 'total',
                     xns : Roo.data,
                     '|xns' : 'Roo.data'
                    }
                   }
                  },
                  {
                   xtype : 'ComboBox',
                   allowBlank : false,
                   alwaysQuery : true,
                   displayField : 'title',
                   editable : true,
                   fieldLabel : _this._strings['6d222e766779a92d741327ef936686c0'] /* Spoken Language */,
                   forceSelection : false,
                   hiddenName : 'lang',
                   listWidth : 400,
                   loadingText : _this._strings['1243daf593fa297e07ab03bf06d925af'] /* Searching... */,
                   minChars : 1,
                   name : 'lang_name',
                   pageSize : 20,
                   qtip : _this._strings['6c768695a8efb18436d5b7b4374cdb45'] /* Select core_enum */,
                   queryParam : '_title',
                   selectOnFocus : true,
                   tpl : '<div class=\"x-grid-cell-text x-btn button\"><b>{title}</b> </div>',
                   triggerAction : 'all',
                   typeAhead : true,
                   valueField : 'code',
                   width : 200,
                   xns : Roo.form,
                   '|xns' : 'Roo.form',
                   store : {
                    xtype : 'Store',
                    remoteSort : true,
                    sortInfo : { direction : 'ASC', field: 'lval' },
                    listeners : {
                     beforeload : function (_self, o){
                          o.params = o.params || {};
                          // set more here
                          //o.params.etype = 'COMPTYPE';
                          o.params.ltype = 'l';
                          o.params._as_code_and_title = 1;
                      }
                    },
                    xns : Roo.data,
                    '|xns' : 'Roo.data',
                    proxy : {
                     xtype : 'HttpProxy',
                     method : 'GET',
                     url : baseURL + '/Roo/I18n.php',
                     xns : Roo.data,
                     '|xns' : 'Roo.data'
                    },
                    reader : {
                     xtype : 'JsonReader',
                     fields : [
                         {
                             'name': 'code',
                             'type': 'string'
                         },
                         {
                             'name': 'title',
                             'type': 'string'
                         }
                         
                     ],
                     id : 'id',
                     root : 'data',
                     totalProperty : 'total',
                     xns : Roo.data,
                     '|xns' : 'Roo.data'
                    }
                   }
                  },
                  {
                   xtype : 'ComboBoxArray',
                   fieldLabel : _this._strings['fad695291417e5155ae516f699edefa1'] /* Locations Covered/Targeted */,
                   hiddenName : 'crm_location_covered',
                   name : 'crm_location_covered_display_name',
                   width : 215,
                   xns : Roo.form,
                   '|xns' : 'Roo.form',
                   combo : {
                    xtype : 'ComboBox',
                    allowBlank : true,
                    alwaysQuery : true,
                    displayField : 'display_name',
                    editable : true,
                    forceSelection : true,
                    idField : 'id',
                    listWidth : 400,
                    minChars : 1,
                    nameField : 'display_name',
                    pageSize : 25,
                    queryParam : 'search[display_name]',
                    tpl : '<div class=\"x-grid-cell-text x-btn button\"><b>{display_name}</b> </div>',
                    triggerAction : 'all',
                    valueField : 'id',
                    width : 217,
                    listeners : {
                     add : function (combo)
                      {
                         Pman.Dialog.CrmLocationCovered.show({ id: 0 }, function(data) { 
                             
                              // add it to this ...
                          });
                          
                          
                      },
                     render : function (_self)
                      {
                       combo.addicon.setStyle( {
                              position : 'absolute',
                              right: '9px',
                              top : '2px',
                              float : 'left'
                          });
                      }
                    },
                    xns : Roo.form,
                    '|xns' : 'Roo.form',
                    store : {
                     xtype : 'Store',
                     remoteSort : true,
                     sortInfo : { direction : 'ASC', field: 'display_name' },
                     listeners : {
                      beforeload : function (_self, o){
                           o.params = o.params || {};
                           // set more here
                           o.params.etype = 'crm_location_covered';
                           o.params.active  = 1;
                       }
                     },
                     xns : Roo.data,
                     '|xns' : 'Roo.data',
                     proxy : {
                      xtype : 'HttpProxy',
                      method : 'GET',
                      url : baseURL + '/Roo/core_enum.php',
                      xns : Roo.data,
                      '|xns' : 'Roo.data'
                     },
                     reader : {
                      xtype : 'JsonReader',
                      fields : [{"name":"id","type":"int"},{"name":"etype","type":"string"}],
                      id : 'code',
                      root : 'data',
                      totalProperty : 'total',
                      xns : Roo.data,
                      '|xns' : 'Roo.data'
                     }
                    }
                   }
                  },
                  {
                   xtype : 'ComboBox',
                   allowBlank : true,
                   alwaysQuery : true,
                   displayField : 'display_name',
                   editable : true,
                   emptyText : _this._strings['51ce726b5887583d02d44df083c49ecc'] /* Select Current Relationship */,
                   fieldLabel : _this._strings['844cb2d0c0304fd7df39b2f522c8c5cc'] /* Current Relationship */,
                   forceSelection : true,
                   hiddenName : 'crm_current_relationship_id',
                   listWidth : 400,
                   loadingText : _this._strings['1243daf593fa297e07ab03bf06d925af'] /* Searching... */,
                   minChars : 1,
                   name : 'crm_current_relationship_id_display_name',
                   pageSize : 20,
                   qtip : _this._strings['51ce726b5887583d02d44df083c49ecc'] /* Select Current Relationship */,
                   queryParam : 'search[display_name]',
                   selectOnFocus : true,
                   tpl : '<div class=\"x-grid-cell-text x-btn button\"><b>{display_name}</b> </div>',
                   triggerAction : 'all',
                   typeAhead : false,
                   valueField : 'id',
                   width : 200,
                   xns : Roo.form,
                   '|xns' : 'Roo.form',
                   store : {
                    xtype : 'Store',
                    remoteSort : true,
                    sortInfo : { direction : 'ASC', field: 'display_name' },
                    listeners : {
                     beforeload : function (_self, o){
                          o.params = o.params || {};
                          // set more here
                          o.params.etype = 'crm_current_relationship_id';
                          o.params.active  = 1;
                      }
                    },
                    xns : Roo.data,
                    '|xns' : 'Roo.data',
                    proxy : {
                     xtype : 'HttpProxy',
                     method : 'GET',
                     url : baseURL + '/Roo/core_enum.php',
                     xns : Roo.data,
                     '|xns' : 'Roo.data'
                    },
                    reader : {
                     xtype : 'JsonReader',
                     fields : [{"name":"id","type":"int"},{"name":"etype","type":"string"}],
                     id : 'id',
                     root : 'data',
                     totalProperty : 'total',
                     xns : Roo.data,
                     '|xns' : 'Roo.data'
                    }
                   }
                  },
                  {
                   xtype : 'ComboBox',
                   allowBlank : true,
                   alwaysQuery : true,
                   displayField : 'display_name',
                   editable : true,
                   emptyText : _this._strings['777171b4509a74cdb3ad40069c584d02'] /* Select a Source */,
                   fieldLabel : _this._strings['f31bbdd1b3e85bccd652680e16935819'] /* Source */,
                   forceSelection : true,
                   hiddenName : 'crm_source_id',
                   listWidth : 400,
                   loadingText : _this._strings['1243daf593fa297e07ab03bf06d925af'] /* Searching... */,
                   minChars : 1,
                   name : 'crm_source_id_display_name',
                   pageSize : 20,
                   qtip : _this._strings['777171b4509a74cdb3ad40069c584d02'] /* Select a Source */,
                   queryParam : 'search[display_name]',
                   selectOnFocus : true,
                   tpl : '<div class=\"x-grid-cell-text x-btn button\"><b>{display_name}</b> </div>',
                   triggerAction : 'all',
                   typeAhead : false,
                   valueField : 'id',
                   width : 200,
                   listeners : {
                    add : function (combo)
                     {
                         Pman.Dialog.CrmSource.show({id:0});
                     }
                   },
                   xns : Roo.form,
                   '|xns' : 'Roo.form',
                   store : {
                    xtype : 'Store',
                    remoteSort : true,
                    sortInfo : { direction : 'ASC', field: 'display_name' },
                    listeners : {
                     beforeload : function (_self, o){
                          o.params = o.params || {};
                          // set more here
                          o.params.etype = 'crm_source';
                          o.params.active  = 1;
                      }
                    },
                    xns : Roo.data,
                    '|xns' : 'Roo.data',
                    proxy : {
                     xtype : 'HttpProxy',
                     method : 'GET',
                     url : baseURL + '/Roo/core_enum.php',
                     xns : Roo.data,
                     '|xns' : 'Roo.data'
                    },
                    reader : {
                     xtype : 'JsonReader',
                     fields : [{"name":"id","type":"int"},{"name":"etype","type":"string"}],
                     id : 'id',
                     root : 'data',
                     totalProperty : 'total',
                     xns : Roo.data,
                     '|xns' : 'Roo.data'
                    }
                   }
                  },
                  {
                   xtype : 'Row',
                   width : 500,
                   xns : Roo.form,
                   '|xns' : 'Roo.form',
                   items  : [
                    {
                     xtype : 'Column',
                     labelWidth : 140,
                     width : 180,
                     xns : Roo.form,
                     '|xns' : 'Roo.form',
                     items  : [
                      {
                       xtype : 'Checkbox',
                       fieldLabel : _this._strings['f8b41731930d0fb224210173cd5eff40'] /* Primary Contact */,
                       name : 'crm_is_primary_contact',
                       width : 200,
                       xns : Roo.form,
                       '|xns' : 'Roo.form'
                      }
                     ]
                    },
                    {
                     xtype : 'Column',
                     labelWidth : 140,
                     width : 200,
                     xns : Roo.form,
                     '|xns' : 'Roo.form',
                     items  : [
                      {
                       xtype : 'Checkbox',
                       fieldLabel : _this._strings['4da9ac510e44c4852d1290ab76b985a8'] /* Key Decision Maker */,
                       name : 'crm_is_decision_maker',
                       width : 200,
                       xns : Roo.form,
                       '|xns' : 'Roo.form'
                      }
                     ]
                    }
                   ]
                  }
                 ]
                }
               ]
              }
             ]
            },
            {
             xtype : 'FieldSet',
             legend : _this._strings['9b7ac356a686920f9f832ebd7d94997c'] /* Project Filing */,
             listeners : {
              render : function (self) {
               
               
                   _this.project  = this;
                   this.hide();
               }
             },
             xns : Roo.form,
             '|xns' : 'Roo.form',
             items  : [
              {
               xtype : 'Checkbox',
               boxLabel : _this._strings['6d2b3c608551bf2a38dc0c8b6cb298bc'] /* Always File Messages from this Person in Project */,
               fieldLabel : _this._strings['0d41a61d4678361579ed786ea1a15772'] /* AutoFile? */,
               name : 'project_id_fs',
               width : 200,
               xns : Roo.form,
               '|xns' : 'Roo.form'
              },
              {
               xtype : 'ComboBox',
               allowBlank : true,
               displayField : 'name',
               editable : true,
               emptyText : _this._strings['ded4cba1b04eb8236e24a3e39470d8a7'] /* Select Campaign */,
               fieldLabel : _this._strings['f00a1d99f6f47917006e88a803ecde1f'] /* Campaign */,
               forceSelection : true,
               hiddenName : 'project_id',
               listWidth : 300,
               loadingText : _this._strings['1243daf593fa297e07ab03bf06d925af'] /* Searching... */,
               minChars : 2,
               name : 'project_id_name',
               pageSize : 100,
               qtip : _this._strings['6a58f977f2b623b695a340766f2a6843'] /* Select Project  */,
               queryParam : 'query[name]',
               selectOnFocus : true,
               tpl : '<div class=\"x-grid-cell-text x-btn button\"><b>{name}</b></div>',
               triggerAction : 'all',
               typeAhead : true,
               valueField : 'id',
               width : 200,
               listeners : {
                beforerender : function (_self)
                 {
                     if(typeof(Pman.Tab.PressReleaseTab) != 'undefined'){
                         this.tpl = '<div class="x-grid-cell-text x-btn button"><b>#{pressrelease_id} - {name}</b></div>';
                     }
                     
                 }
               },
               xns : Roo.form,
               '|xns' : 'Roo.form',
               store : {
                xtype : 'Store',
                remoteSort : true,
                sortInfo : {field : 'name', direction : 'ASC'},
                listeners : {
                 beforeload : function (_self, o)
                  {
                      o.params = o.params || {};
                      // o.params.client_id = Pman.Login.authUser.company_id;
                      if (Pman.hasPerm('PressRelease.MainTab','S')) {
                          o.params['!pressrelease_id']= 0;
                          this.sortInfo.field = 'id';
                      }
                      
                  }
                },
                xns : Roo.data,
                '|xns' : 'Roo.data',
                proxy : {
                 xtype : 'HttpProxy',
                 method : 'GET',
                 url : baseURL + '/Roo/Core_project.php',
                 xns : Roo.data,
                 '|xns' : 'Roo.data'
                },
                reader : {
                 xtype : 'JsonReader',
                 id : 'id',
                 root : 'data',
                 totalProperty : 'total',
                 xns : Roo.data,
                 '|xns' : 'Roo.data'
                }
               },
               tpl : {
                xtype : 'Template',
                formatName : function(v, allv) {
                    return  String.format(allv.pressrelease_id*1? '{0}' :  '<B>{0}</B>',v )
                 },
                formatPR : function(v, allv) {
                       return  String.format(v*1? '#<B>{0}</B> ' :  '',v )
                 },
                html : _this._strings['10ffcae93e0ef4941193179b3b2f2d6a'] /* <div class="x-grid-cell-text x-btn button">{pressrelease_id:this.formatPR}{name:this.formatName} </div> */,
                xns : Roo,
                '|xns' : 'Roo'
               }
              },
              {
               xtype : 'Checkbox',
               fieldLabel : _this._strings['f789853b5a3d39a56a2fb59b0892b598'] /* Is Action Required? */,
               name : 'is_action_required',
               width : 200,
               xns : Roo.form,
               '|xns' : 'Roo.form'
              }
             ]
            },
            {
             xtype : 'FieldSet',
             legend : _this._strings['6f54043edff88231017ffe8a1f092f44'] /* Contact Details */,
             xns : Roo.form,
             '|xns' : 'Roo.form',
             items  : [
              {
               xtype : 'Row',
               labelWidth : 110,
               width : 420,
               xns : Roo.form,
               '|xns' : 'Roo.form',
               items  : [
                {
                 xtype : 'TextField',
                 allowBlank : false,
                 fieldLabel : _this._strings['ce8ae9da5b7cd6c3df2929543a9af92d'] /* Email */,
                 name : 'email',
                 vtype : 'email',
                 width : 290,
                 listeners : {
                  blur : function (_self)
                   {
                       _this.form.validEmail();
                   },
                  render : function (_self)
                   {
                       _this.emailField = _self;
                   }
                 },
                 xns : Roo.form,
                 '|xns' : 'Roo.form'
                },
                {
                 xtype : 'TextField',
                 fieldLabel : _this._strings['20eccd627374be9efeaa81e67c2e1443'] /* Secondary Email */,
                 name : 'alt_email',
                 vtype : 'email',
                 width : 290,
                 xns : Roo.form,
                 '|xns' : 'Roo.form'
                },
                {
                 xtype : 'TextField',
                 fieldLabel : _this._strings['751d204230c22fb929f7feb90884a959'] /* Twitter handle */,
                 name : 'url_twitter',
                 width : 290,
                 xns : Roo.form,
                 '|xns' : 'Roo.form'
                },
                {
                 xtype : 'TextField',
                 fieldLabel : _this._strings['90bfdc4085f24f340d732886ca10e1a0'] /* Blog Website */,
                 name : 'url_blog',
                 vtype : 'url',
                 width : 290,
                 xns : Roo.form,
                 '|xns' : 'Roo.form'
                },
                {
                 xtype : 'TextField',
                 fieldLabel : _this._strings['e884c507c5198a4578a84498f7a323e2'] /* LinkedIn */,
                 name : 'url_linkedin',
                 vtype : 'url',
                 width : 290,
                 xns : Roo.form,
                 '|xns' : 'Roo.form'
                },
                {
                 xtype : 'TextField',
                 fieldLabel : _this._strings['01c3c4d5f15312f6c0ae7913eb54e1d9'] /* WeChat ID */,
                 name : 'wechat_id',
                 width : 290,
                 xns : Roo.form,
                 '|xns' : 'Roo.form'
                }
               ]
              }
             ]
            },
            {
             xtype : 'FieldSet',
             legend : _this._strings['054c93063db5b62b23b48ef801f27aa0'] /* Phone numbers */,
             xns : Roo.form,
             '|xns' : 'Roo.form',
             items  : [
              {
               xtype : 'Row',
               labelWidth : 80,
               width : 420,
               xns : Roo.form,
               '|xns' : 'Roo.form',
               items  : [
                {
                 xtype : 'TextField',
                 fieldLabel : _this._strings['df814135652a5a308fea15bff37ea284'] /* Office */,
                 name : 'office_phone',
                 readOnly : true,
                 width : 100,
                 listeners : {
                  render : function (_self)
                   {
                       this.el.on('click', function(){
                            var rowIndex = -1;
                            Roo.each(_this.grid.ds.data.items, function(r,k){
                               
                                if(r.data.has_selected) { rowIndex = k; }
                            });
                         
                            if(rowIndex < 0){
                            
                                if(_this.cform.findField('id').getValue() > 0){
                                    Pman.Dialog.CrmOffice.show( {
                                            id : 0, 
                                            company_id : _this.cform.findField('id').getValue(),
                                            phone : _this.data.phone
                                            
                                        } , function(data) {
                                        _this.form.findField('office_id').setValue(data.id);
                                        _this.grid.ds.load({});
                                    }); 
                                    return;
                                }else{
                                    Roo.MessageBox.alert('Error', 'Please add/select a company first');
                                    return;
                                }
                                
                                 
                            }
                            Pman.Dialog.CrmOffice.show( _this.grid.ds.getAt(rowIndex).data, function() {
                               _this.grid.ds.load({});
                            }); 
                            
                            (function () { 
                                   var tp = Pman.Dialog.CrmOffice.form.findField('phone');
                                   if (tp.getValue().length < 1 && _this.data.phone.length > 0) {
                                       tp.setValue(_this.data.phone);
                                   }
                               }).defer(500)
                            
                            
                        });
                   }
                 },
                 xns : Roo.form,
                 '|xns' : 'Roo.form'
                },
                {
                 xtype : 'Column',
                 hideLabels : true,
                 width : 50,
                 xns : Roo.form,
                 '|xns' : 'Roo.form',
                 items  : [
                  {
                   xtype : 'TextField',
                   allowBlank : true,
                   name : 'ext',
                   width : 50,
                   xns : Roo.form,
                   '|xns' : 'Roo.form'
                  }
                 ]
                }
               ]
              },
              {
               xtype : 'Row',
               xns : Roo.form,
               '|xns' : 'Roo.form',
               items  : [
                {
                 xtype : 'Column',
                 labelWidth : 80,
                 xns : Roo.form,
                 '|xns' : 'Roo.form',
                 items  : [
                  {
                   xtype : 'TextField',
                   allowBlank : true,
                   fieldLabel : _this._strings['87d17f4624a514e81dc7c8e016a7405c'] /* Mobile */,
                   name : 'phone_mobile',
                   width : 100,
                   xns : Roo.form,
                   '|xns' : 'Roo.form'
                  }
                 ]
                }
               ]
              },
              {
               xtype : 'Row',
               xns : Roo.form,
               '|xns' : 'Roo.form',
               items  : [
                {
                 xtype : 'Column',
                 labelWidth : 80,
                 xns : Roo.form,
                 '|xns' : 'Roo.form',
                 items  : [
                  {
                   xtype : 'TextField',
                   allowBlank : true,
                   fieldLabel : _this._strings['69a696cc505197bd6b17c2f85b692faa'] /* Direct Line */,
                   name : 'phone_direct',
                   width : 100,
                   xns : Roo.form,
                   '|xns' : 'Roo.form'
                  }
                 ]
                }
               ]
              }
             ]
            },
            {
             xtype : 'FieldSet',
             legend : _this._strings['0de4afdad57ed10d2663be2f84481601'] /* Ownership */,
             listeners : {
              render : function (_self)
               {
                   _this.ownerSet = this;
               }
             },
             xns : Roo.form,
             '|xns' : 'Roo.form',
             items  : [
              {
               xtype : 'Row',
               labelWidth : 140,
               width : 420,
               xns : Roo.form,
               '|xns' : 'Roo.form',
               items  : [
                {
                 xtype : 'ComboBox',
                 allowBlank : true,
                 alwaysQuery : true,
                 displayField : 'name',
                 editable : false,
                 emptyText : _this._strings['21ec484b4de76650a90d349763586b01'] /* Select Owner */,
                 fieldLabel : _this._strings['96fdac283668b2490c859ef6ea97c86e'] /* Owner of this record */,
                 forceSelection : true,
                 hiddenName : 'owner_id',
                 listWidth : 400,
                 loadingText : _this._strings['1243daf593fa297e07ab03bf06d925af'] /* Searching... */,
                 minChars : 1,
                 name : 'owner_id_name',
                 pageSize : 20,
                 qtip : _this._strings['a2fa78bdc038a0a1df5caff2ac1ad945'] /* Who owns this record */,
                 queryParam : 'search[name]',
                 selectOnFocus : true,
                 tpl : '<div class=\"x-grid-cell-text x-btn button\"><b>{name}</b> {email}</div>',
                 triggerAction : 'all',
                 typeAhead : false,
                 valueField : 'id',
                 width : 200,
                 xns : Roo.form,
                 '|xns' : 'Roo.form',
                 store : {
                  xtype : 'Store',
                  remoteSort : true,
                  sortInfo : { direction : 'ASC', field: 'name' },
                  listeners : {
                   beforeload : function (_self, o){
                        o.params = o.params || {};
                        // set more here
                        o.params['query[is_owner]'] = 1;
                        o.params.active  = 1;
                        o.params['_can_own_contacts'] = 1;
                    },
                   load : function (_self, records, options)
                    {
                        var ownerRecord = false;
                        Roo.each(records, function(r, i)  {
                            if(r.id == Pman.Login.authUserId) {
                                ownerRecord = r;
                            }
                        });
                        
                        if(ownerRecord !== false) {
                            _self.remove(ownerRecord);
                            _self.insert(0, ownerRecord);
                            ownerRecord.set('name', 'Me: ' + ownerRecord.get('name'));
                        }
                        
                    }
                  },
                  xns : Roo.data,
                  '|xns' : 'Roo.data',
                  proxy : {
                   xtype : 'HttpProxy',
                   method : 'GET',
                   url : baseURL + '/Roo/core_person',
                   xns : Roo.data,
                   '|xns' : 'Roo.data'
                  },
                  reader : {
                   xtype : 'JsonReader',
                   id : 'id',
                   root : 'data',
                   totalProperty : 'total',
                   xns : Roo.data,
                   '|xns' : 'Roo.data'
                  }
                 }
                }
               ]
              }
             ]
            },
            {
             xtype : 'Row',
             labelAlign : 'top',
             width : 420,
             xns : Roo.form,
             '|xns' : 'Roo.form',
             items  : [
              {
               xtype : 'TextArea',
               actionMode : 'fieldEl',
               fieldLabel : _this._strings['e5d579ff9d4caf59887ae80dff261acf'] /* First Meeting Notes */,
               height : 100,
               hideMode : 'display',
               name : 'meeting_notes',
               width : 430,
               xns : Roo.form,
               '|xns' : 'Roo.form'
              }
             ]
            },
            {
             xtype : 'Row',
             labelAlign : 'top',
             width : 420,
             xns : Roo.form,
             '|xns' : 'Roo.form',
             items  : [
              {
               xtype : 'TextArea',
               fieldLabel : _this._strings['db530ec5680ef36a942d39c25043928d'] /* Key Reference Notes */,
               height : 100,
               name : 'remarks',
               width : 430,
               xns : Roo.form,
               '|xns' : 'Roo.form'
              }
             ]
            },
            {
             xtype : 'FieldSet',
             legend : _this._strings['a3e4f4667d88fd6ee4604cebc8d34255'] /* Contact Status */,
             xns : Roo.form,
             '|xns' : 'Roo.form',
             items  : [
              {
               xtype : 'Row',
               labelWidth : 140,
               width : 420,
               xns : Roo.form,
               '|xns' : 'Roo.form',
               items  : [
                {
                 xtype : 'Column',
                 labelWidth : 25,
                 width : 50,
                 xns : Roo.form,
                 '|xns' : 'Roo.form',
                 items  : [
                  {
                   xtype : 'DisplayField',
                   fieldLabel : _this._strings['c87d56de44398002b913008dac333ce7'] /* Fails */,
                   name : 'email_fails',
                   xns : Roo.form,
                   '|xns' : 'Roo.form'
                  }
                 ]
                },
                {
                 xtype : 'Column',
                 labelWidth : 0,
                 width : 70,
                 xns : Roo.form,
                 '|xns' : 'Roo.form',
                 items  : [
                  {
                   xtype : 'Button',
                   text : _this._strings['86266ee937d97f812a8e57d22b62ee29'] /* reset */,
                   listeners : {
                    click : function (_self, e)
                     {
                         _this.form.findField('email_fails').setValue(0);
                     }
                   },
                   xns : Roo,
                   '|xns' : 'Roo'
                  }
                 ]
                }
               ]
              },
              {
               xtype : 'Row',
               listeners : {
                render : function (_self)
                 {
                     _this.noMxRow = _self;
                 }
               },
               xns : Roo.form,
               '|xns' : 'Roo.form',
               items  : [
                {
                 xtype : 'Column',
                 labelWidth : 120,
                 width : 250,
                 xns : Roo.form,
                 '|xns' : 'Roo.form',
                 items  : [
                  {
                   xtype : 'DisplayField',
                   fieldLabel : _this._strings['4dba2e47f2f6bc2d0347e04dd44ecf9b'] /* No mx records since */,
                   name : 'domain_id_no_mx_dt',
                   valueRenderer : function()
                   {
                       if(!_this.form) {
                           return '';
                       }
                       
                       var no_mx_dt = _this.form.findField('domain_id_no_mx_dt').value;
                       
                       var ret = no_mx_dt instanceof Date ? no_mx_dt.format('Y-m-d H:i:s') : no_mx_dt;
                       
                       if(ret == '1000-01-01 00:00:00') {
                           return 'N/A'
                       }
                       
                       return String.format("<span style='color:red;'>{0}</span>", ret);
                   },
                   width : 130,
                   xns : Roo.form,
                   '|xns' : 'Roo.form'
                  }
                 ]
                },
                {
                 xtype : 'Column',
                 width : 100,
                 xns : Roo.form,
                 '|xns' : 'Roo.form',
                 items  : [
                  {
                   xtype : 'Button',
                   text : _this._strings['d7a278dd23696e10a4346c918891a82a'] /* update MX */,
                   listeners : {
                    click : function (_self, e)
                     {
                         var id = _this.data.domain_id;
                         
                         if(!(id * 1)) {
                             Roo.MessageBox.alert('Error', 'No domain_id');
                             return;
                         }
                         
                         new Pman.Request({
                            url : baseURL + '/Roo/core_domain.php',
                            method : 'POST',
                            mask: "Updating",
                            params : {
                                id : id,
                                _update_mx : 1
                            }, 
                            success : function(res) {
                                 if(_this.data.id){
                                     _this.form.load({ method: 'GET', params: { '_id' : _this.data.id }});
                                 }
                            }
                        });
                     }
                   },
                   xns : Roo,
                   '|xns' : 'Roo'
                  }
                 ]
                }
               ]
              }
             ]
            },
            {
             xtype : 'FieldSet',
             legend : _this._strings['be649b4ca625c123850b1d9125753d7c'] /* Spam Status */,
             xns : Roo.form,
             '|xns' : 'Roo.form',
             items  : [
              {
               xtype : 'Row',
               labelWidth : 75,
               width : 100,
               xns : Roo.form,
               '|xns' : 'Roo.form',
               items  : [
                {
                 xtype : 'Checkbox',
                 fieldLabel : _this._strings['70012379217db5897b48b958401effc3'] /* Is Spammer */,
                 name : 'email_is_spam',
                 width : 150,
                 xns : Roo.form,
                 '|xns' : 'Roo.form'
                }
               ]
              }
             ]
            },
            {
             xtype : 'Hidden',
             name : 'company_id',
             xns : Roo.form,
             '|xns' : 'Roo.form'
            },
            {
             xtype : 'Hidden',
             name : 'meeting_notes_id',
             xns : Roo.form,
             '|xns' : 'Roo.form'
            },
            {
             xtype : 'Hidden',
             name : 'enquiry_id',
             xns : Roo.form,
             '|xns' : 'Roo.form'
            },
            {
             xtype : 'Hidden',
             name : 'phone',
             xns : Roo.form,
             '|xns' : 'Roo.form'
            },
            {
             xtype : 'Hidden',
             name : 'office_id',
             xns : Roo.form,
             '|xns' : 'Roo.form'
            },
            {
             xtype : 'Hidden',
             name : 'id',
             xns : Roo.form,
             '|xns' : 'Roo.form'
            }
           ]
          }
         ]
        },
        {
         xtype : 'NestedLayoutPanel',
         region : 'east',
         xns : Roo,
         '|xns' : 'Roo',
         layout : {
          xtype : 'BorderLayout',
          xns : Roo,
          '|xns' : 'Roo',
          center : {
           xtype : 'LayoutRegion',
           xns : Roo,
           '|xns' : 'Roo'
          },
          north : {
           xtype : 'LayoutRegion',
           height : 200,
           xns : Roo,
           '|xns' : 'Roo'
          },
          items  : [
           {
            xtype : 'ContentPanel',
            autoScroll : true,
            fitToFrame : true,
            region : 'north',
            xns : Roo,
            '|xns' : 'Roo',
            toolbar : {
             xtype : 'Toolbar',
             xns : Roo,
             '|xns' : 'Roo',
             items  : [
              {
               xtype : 'Fill',
               xns : Roo.Toolbar,
               '|xns' : 'Roo.Toolbar'
              },
              {
               xtype : 'Button',
               cls : 'x-btn-text-icon',
               icon : Roo.rootURL + 'images/default/tree/leaf.gif',
               text : _this._strings['66bc3ece76861852889e623217049d32'] /* Edit Company Details */,
               listeners : {
                click : function()
                 {
                     var data = _this.cform.getValues();
                     
                     if(data.id == 0){
                         Roo.MessageBox.alert('Error', 'Please add a new company');
                         return;
                     }
                     
                     Pman.Dialog.CrmCompany.show( { id : data.id } , function(res) {
                         _this.cform.fireEvent('actioncomplete', _this.form,  { type: 'setdata', data: {company_id :  data.id} });
                         _this.grid.ds.load({});
                    }); 
                 }
               },
               xns : Roo.Toolbar,
               '|xns' : 'Roo.Toolbar'
              }
             ]
            },
            items  : [
             {
              xtype : 'Form',
              labelAlign : 'right',
              labelWidth : 100,
              method : 'POST',
              style : 'margin:10px;',
              url : baseURL + '/Roo/core_company',
              listeners : {
               actioncomplete : function(_self,action)
                {
                    if (action.type == 'setdata') {
                       if(action.data.company_id > 0) {
                           this.load({ method: 'GET', params: { '_id' : action.data.company_id }});
                        }
                       return;
                    }
                    if (action.type == 'load') {
                        if(_this.grid) { _this.grid.ds.load({}); }
                        return;
                    }
                    if (action.type =='submit') {
                    /*
                        
                        if(action.result.data.id > 0){
                            //_this.form.fireEvent('actioncomplete', {},  { type: 'setdata', data: {} });
                            //_this.cform.setValues(action.result.data);
                            _this.form.doAction("submit");
                        }
                        _this.dialog.hide();
                    
                         if (_this.callback) {
                            _this.callback.call(_this, _this.form.getValues());
                         }
                         _this.form.reset();
                         _this.cform.reset();
                         */
                         return;
                    }
                },
               actionfailed : function (_self, action)
                {
                    _this.dialog.el.unmask();
                    Roo.MessageBox.alert('Error', 'fix all the errors in red');
                },
               rendered : function (form)
                {
                    _this.cform = form;
                }
              },
              xns : Roo.form,
              '|xns' : 'Roo.form',
              items  : [
               {
                xtype : 'Row',
                labelAlign : 'right',
                labelWidth : 100,
                xns : Roo.form,
                '|xns' : 'Roo.form',
                items  : [
                 {
                  xtype : 'ComboBox',
                  allowBlank : false,
                  alwaysQuery : true,
                  displayField : 'name',
                  editable : true,
                  fieldLabel : _this._strings['e7b47c58815acf1d3afa59a84b5db7fb'] /* Company Name */,
                  forceSelection : false,
                  hiddenName : 'id',
                  listWidth : 400,
                  loadingText : _this._strings['1243daf593fa297e07ab03bf06d925af'] /* Searching... */,
                  minChars : 1,
                  name : 'name',
                  pageSize : 20,
                  qtip : _this._strings['6c768695a8efb18436d5b7b4374cdb45'] /* Select core_enum */,
                  queryParam : '_name',
                  selectOnFocus : true,
                  tpl : '<div class=\"x-grid-cell-text x-btn button\"><b>{name}</b> </div>',
                  triggerAction : 'all',
                  typeAhead : true,
                  valueField : 'id',
                  width : 200,
                  listeners : {
                   add : function (combo)
                    {  
                       Pman.Dialog.CrmCompany.show( { id : 0 } , function(res) {
                            Roo.log(res);
                            _this.cform.fireEvent('actioncomplete', _this.cform,  { type: 'setdata', data: { company_id: res.id} });
                            //_this.cform.setValues(res.id);
                    
                            _this.form.setValues({ company_id : res.id, office_id : 0 });
                            _this.grid.ds.load({});
                            //_this.grid.footer.onClick('first');
                       });
                    },
                   select : function (combo, record, index)
                    {
                        //reset the value
                        
                        _this.cform.setValues(record.data);
                        if (_this.form.findField('company_id').getValue()*1 == record.data.id*1) {
                            return;
                        }
                    
                        _this.form.setValues({ company_id : record.data.id, office_id :  0});
                    
                        _this.grid.ds.load({});
                    }
                  },
                  xns : Roo.form,
                  '|xns' : 'Roo.form',
                  store : {
                   xtype : 'Store',
                   remoteSort : true,
                   sortInfo : { direction : 'ASC', field: 'name' },
                   listeners : {
                    beforeload : function (_self, o){
                         o.params = o.params || {};
                         // set more here
                         //o.params.etype = 'COMPTYPE';
                         
                     },
                    load : function (_self, records, options)
                     {
                         if(records.length == 0){ // set value to empty
                             
                             _this.cform.findField('id').value = 0;
                             _this.cform.findField('id').hiddenField.value = 0;
                             
                             _this.cform.findField('url').setValue('');
                             _this.cform.findField('comptype_id_display_name').setValue('');
                             _this.cform.findField('crm_industry_id_display_name').setValue('');
                             _this.cform.findField('crm_business_focus').setValue('');
                             _this.cform.findField('crm_client_of_competitor').setValue('');
                           //  _this.cform.findField('comptype_id').setValue('');
                            // _this.cform.findField('crm_industry_id').setValue('');
                           //  _this.cform.findField('url').el.dom.readOnly = false;
                           //  _this.cform.findField('comptype_id').enable();
                          //   _this.cform.findField('crm_industry_id').enable();
                         }
                     }
                   },
                   xns : Roo.data,
                   '|xns' : 'Roo.data',
                   proxy : {
                    xtype : 'HttpProxy',
                    method : 'GET',
                    url : baseURL + '/Roo/core_company',
                    xns : Roo.data,
                    '|xns' : 'Roo.data'
                   },
                   reader : {
                    xtype : 'JsonReader',
                    id : 'id',
                    root : 'data',
                    totalProperty : 'total',
                    xns : Roo.data,
                    '|xns' : 'Roo.data'
                   }
                  }
                 },
                 {
                  xtype : 'DisplayField',
                  fieldLabel : _this._strings['15bbb9d0bbf25e8d2978de1168c749dc'] /* Website */,
                  name : 'url',
                  value : _this._strings['d41d8cd98f00b204e9800998ecf8427e'] /*   */,
                  vtype : 'url',
                  width : 200,
                  xns : Roo.form,
                  '|xns' : 'Roo.form'
                 },
                 {
                  xtype : 'DisplayField',
                  fieldLabel : _this._strings['1814dfa23ca67a5b93237922728b52e3'] /* Company Type */,
                  name : 'comptype_id_display_name',
                  value : _this._strings['d41d8cd98f00b204e9800998ecf8427e'] /*   */,
                  vtype : 'url',
                  width : 200,
                  xns : Roo.form,
                  '|xns' : 'Roo.form'
                 },
                 {
                  xtype : 'DisplayField',
                  fieldLabel : _this._strings['4fd0a37b0a02153b23bbb61d7915a429'] /* Industry */,
                  name : 'crm_industry_id_display_name',
                  value : _this._strings['d41d8cd98f00b204e9800998ecf8427e'] /*   */,
                  vtype : 'url',
                  width : 200,
                  xns : Roo.form,
                  '|xns' : 'Roo.form'
                 },
                 {
                  xtype : 'DisplayField',
                  fieldLabel : _this._strings['38be0abb8dcd2feda6d12b0f0cfb553d'] /* Business Focus */,
                  name : 'crm_business_focus',
                  value : _this._strings['d41d8cd98f00b204e9800998ecf8427e'] /*   */,
                  vtype : 'url',
                  width : 200,
                  xns : Roo.form,
                  '|xns' : 'Roo.form'
                 },
                 {
                  xtype : 'DisplayField',
                  fieldLabel : _this._strings['8a38074d3c311563d2ebd05955ff4d19'] /* Client of */,
                  name : 'crm_client_of_competitor',
                  value : _this._strings['d41d8cd98f00b204e9800998ecf8427e'] /*  */,
                  vtype : 'url',
                  width : 200,
                  xns : Roo.form,
                  '|xns' : 'Roo.form'
                 },
                 {
                  xtype : 'Hidden',
                  name : 'crm_industry_id',
                  xns : Roo.form,
                  '|xns' : 'Roo.form'
                 }
                ]
               }
              ]
             }
            ]
           },
           {
            xtype : 'GridPanel',
            background : false,
            fitContainer : true,
            fitToframe : true,
            region : 'center',
            tableName : 'Office',
            title : _this._strings['df814135652a5a308fea15bff37ea284'] /* Office */,
            listeners : {
             activate : function() {
                  _this.panel = this;
                  if (_this.grid) {
                     //(function() { _this.grid.footer.onClick('first'); }).defer(1000);
                  }
              }
            },
            xns : Roo,
            '|xns' : 'Roo',
            grid : {
             xtype : 'Grid',
             autoExpandColumn : 'address',
             loadMask : true,
             listeners : {
              cellclick : function (_self, rowIndex, colIndex, e)
               {
               
                   if (colIndex != 0) {
                       return;
                   }
                   
                   var data = this.ds.data.items;
                   var el = this;
                   var d = this.ds.getAt(rowIndex);
               
                   var s = d.data.has_selected*1 ? 0 : 1;
                   
                   
                   var not_s = s ? 0 : 1;
                   var id = 0;
                   
                   _this.form.findField('office_id').setValue((s) ? d.data.id : 0);    
                   if (d.data.phone.length > 0 ) {
               //    d.set('has_selected', s);
                       var pAry = d.data.phone.split("+");
                  
                       _this.form.findField('office_phone').setValue((pAry[0]*1 > 0 && s) ? pAry[0]*1 : '');
               
                       _this.form.findField('ext').setValue((pAry.length > 1 && s) ? pAry[1]*1 : '');
                   }
               
                   this.ds.each(function(rec){
                       rec.set('has_selected', rec.data.id == d.data.id ? s : not_s);
                   });
               
               },
              render : function() 
               {
                   _this.grid = this; 
                   //_this.dialog = Pman.Dialog.FILL_IN
                   if (_this.panel.active) {
                      // (function() { _this.grid.footer.onClick('first'); }).defer(1000);
                   }
               },
              rowdblclick : function (_self, rowIndex, e)
               {
                    var d = _this.grid.ds.getAt(rowIndex).data;
                  Pman.Dialog.CrmOffice.show( d, function() {
                      _this.grid.ds.load({});
                   });
                   
                   if (d.id != _this.data.office_id) {
                       return;
                   }
                   
                   (function () { 
                       var tp = Pman.Dialog.CrmOffice.form.findField('phone');
                       if (tp.getValue().length < 1 && _this.data.phone.length > 0) {
                           tp.setValue(_this.data.phone);
                       }
                   }).defer(500)
                    
               }
             },
             xns : Roo.grid,
             '|xns' : 'Roo.grid',
             toolbar : {
              xtype : 'Toolbar',
              xns : Roo,
              '|xns' : 'Roo',
              items  : [
               {
                xtype : 'Button',
                cls : 'x-btn-text-icon',
                icon : Roo.rootURL + 'images/default/dd/drop-add.gif',
                text : _this._strings['0736d73357df264e67d36a66b519122d'] /* Add Office */,
                listeners : {
                 click : function()
                  {
                      if(_this.cform.findField('id').getValue() > 0){
                      
                          var def = {                
                              id : 0, 
                              company_id : _this.cform.findField('id').getValue()
                          };
                          if (_this.form.findField('office_id').getValue()*1 < 1) {
                              def.phone = _this.data.phone;
                          }
                      
                          Pman.Dialog.CrmOffice.show( def , function(data) {
                              _this.form.findField('office_id').setValue(data.id);
                              _this.grid.ds.load({});
                          }); 
                      }else{
                          Roo.MessageBox.alert('Error', 'Please add/select a company first');
                      }
                  }
                },
                xns : Roo.Toolbar,
                '|xns' : 'Roo.Toolbar'
               },
               {
                xtype : 'Fill',
                xns : Roo.Toolbar,
                '|xns' : 'Roo.Toolbar'
               },
               {
                xtype : 'Button',
                cls : 'x-btn-text-icon',
                icon : rootURL + '/Pman/templates/images/trash.gif',
                text : _this._strings['ee3629f5936b16869c4687c79bab8e42'] /* Delete Office */,
                listeners : {
                 click : function()
                  {
                      Pman.genericDelete(_this, 'core_office'); 
                     
                  }
                },
                xns : Roo.Toolbar,
                '|xns' : 'Roo.Toolbar'
               }
              ]
             },
             dataSource : {
              xtype : 'Store',
              remoteSort : true,
              sortInfo : { field : 'name', direction: 'ASC' },
              listeners : {
               beforeload : function (_self, o)
                {
                    o.params = o.params || {};
                    if(_this.cform.findField('id').getValue()){
                        o.params.company_id = _this.cform.findField('id').getValue();
                    }else{
                        return false;
                    }
                    
                },
               load : function (_self, records, options)
                {
                    // if any of them are selected - then we update the phone number..
                    
                    
                    var co = _this.form.findField('office_id').getValue() *1;
                    Roo.each(records, function(r) {
                    
                        if (!co) {
                            co = r.data.id;
                            _this.form.findField('office_id').setValue(co);
                            r.set('has_selected',1);
                            if (r.data.phone.length > 0) {
                                _this.form.findField('office_phone').setValue(r.data.phone); 
                            }
                            return;
                        }
                    
                        if (r.data.id *1 != co) {
                            return;
                        }
                        // found the office - update the phone number.
                        
                        if (r.data.phone.length > 0) {
                            _this.form.findField('office_phone').setValue(r.data.phone);
                        }
                
                    });
                    
                }
              },
              xns : Roo.data,
              '|xns' : 'Roo.data',
              proxy : {
               xtype : 'HttpProxy',
               method : 'GET',
               url : baseURL + '/Roo/core_office',
               xns : Roo.data,
               '|xns' : 'Roo.data'
              },
              reader : {
               xtype : 'JsonReader',
               fields : [
                   {
                       'name': 'id',
                       'type': 'int'
                   },
                   {
                       'name': 'ris_company_id',
                       'type': 'int'
                   },
                   {
                       'name': 'name',
                       'type': 'string'
                   },
                   {
                       'name': 'address',
                       'type': 'string'
                   },
                   {
                       'name': 'phone',
                       'type': 'string'
                   },
                   {
                       'name': 'fax',
                       'type': 'string'
                   },
                   {
                       'name': 'email',
                       'type': 'string'
                   },
                   {
                       'name': 'role',
                       'type': 'string'
                   },
                   {
                       'name': 'sales_staff_no',
                       'type': 'int'
                   },
                   {
                       'name': 'support_staff_no',
                       'type': 'int'
                   },
                   {
                       'name': 'location_id',
                       'type': 'int'
                   },
                   {
                       'name': 'ris_company_id_id',
                       'type': 'int'
                   },
                   {
                       'name': 'ris_company_id_code',
                       'type': 'string'
                   },
                   {
                       'name': 'ris_company_id_name',
                       'type': 'string'
                   },
                   {
                       'name': 'ris_company_id_remarks',
                       'type': 'string'
                   },
                   {
                       'name': 'ris_company_id_owner_id',
                       'type': 'int'
                   },
                   {
                       'name': 'ris_company_id_address',
                       'type': 'string'
                   },
                   {
                       'name': 'ris_company_id_tel',
                       'type': 'string'
                   },
                   {
                       'name': 'ris_company_id_fax',
                       'type': 'string'
                   },
                   {
                       'name': 'ris_company_id_email',
                       'type': 'string'
                   },
                   {
                       'name': 'ris_company_id_logo_id',
                       'type': 'int'
                   },
                   {
                       'name': 'ris_company_id_background_color',
                       'type': 'string'
                   },
                   {
                       'name': 'ris_company_id_comptype',
                       'type': 'string'
                   },
                   {
                       'name': 'ris_company_id_ownership_type_id',
                       'type': 'int'
                   },
                   {
                       'name': 'ris_company_id_url',
                       'type': 'string'
                   },
                   {
                       'name': 'ris_company_id_main_office_id',
                       'type': 'int'
                   },
                   {
                       'name': 'ris_company_id_created_by',
                       'type': 'int'
                   },
                   {
                       'name': 'ris_company_id_created_dt',
                       'type': 'date'
                   },
                   {
                       'name': 'ris_company_id_modified_by',
                       'type': 'int'
                   },
                   {
                       'name': 'ris_company_id_modified_dt',
                       'type': 'date'
                   },
                   {
                       'name': 'ris_company_id_partner_type_id',
                       'type': 'int'
                   },
                   {
                       'name': 'ris_company_id_yr',
                       'type': 'int'
                   },
                   {
                       'name': 'ris_company_id_yr_desc',
                       'type': 'string'
                   },
                   {
                       'name': 'ris_company_id_est_turnover_m',
                       'type': 'float'
                   },
                   {
                       'name': 'ris_company_id_est_profit_m',
                       'type': 'float'
                   },
                   {
                       'name': 'ris_company_id_est_principle_m',
                       'type': 'float'
                   },
                   {
                       'name': 'ris_company_id_est_product_m',
                       'type': 'float'
                   },
                   {
                       'name': 'ris_company_id_est_services_m',
                       'type': 'float'
                   },
                   {
                       'name': 'ris_company_id_ownership_notes',
                       'type': 'string'
                   },
                   {
                       'name': 'ris_company_id_private_notes',
                       'type': 'string'
                   },
                   {
                       'name': 'ris_company_id_established',
                       'type': 'int'
                   },
                   {
                       'name': 'ris_company_id_staff_no',
                       'type': 'int'
                   },
                   {
                       'name': 'location_id_id',
                       'type': 'int'
                   },
                   {
                       'name': 'location_id_name',
                       'type': 'string'
                   },
                   {
                       'name': 'location_id_country',
                       'type': 'string'
                   }
               ],
               id : 'id',
               root : 'data',
               totalProperty : 'total',
               xns : Roo.data,
               '|xns' : 'Roo.data'
              }
             },
             colModel : [
              {
               xtype : 'ColumnModel',
               dataIndex : 'has_selected',
               header : _this._strings['b28cf7bd6a7d817ef920bc394ab49731'] /* Select? */,
               renderer : function(v,x,r)
               {
                   var id = _this.form.findField('office_id').getValue();
                   var state = '';
               
                   if(id > 0 && id == r.data.id){
                       state = '-checked';
                       r.data.has_selected = 1;
                   }else{
                       r.data.has_selected = 0;
                   }
                   return '<img class="x-grid-check-icon' + state + '" src="' + Roo.BLANK_IMAGE_URL + '"/>';
               },
               width : 50,
               xns : Roo.grid,
               '|xns' : 'Roo.grid'
              },
              {
               xtype : 'ColumnModel',
               dataIndex : 'address',
               header : _this._strings['dd7bf230fde8d4836917806aff6a6b27'] /* Address */,
               renderer : function(v,x,r)
               {
                
                  return  [v,  
                       r.data.address2 ,
                        r.data.address3, 
                        r.data.office_id_country_name,
                       r.data.phone && r.data.phone.length ? ( "Tel: " + r.data.phone) : '', 
                       r.data.fax && r.data.fax.length ? ( "Fax: " + r.data.fax) : ''
                       ].filter(
                               function(vv) { return vv && vv.length }
                           ).map(
                               function(vv) { return String.format('{0}', vv) }
                           ).join('<br/>');
                    
                    
                    
                /*
                   return String.format('{0}<br/>{1}<br/>{2}<br/>{3}<br/>Tel: {4}<br/>Fax: {5}', 
                       v,  r.data.address2 , r.data.address3, r.data.office_id_country_name,
                       r.data.phone, r.data.fax).replace(
                               /\<br\/\>(\<br\/\>)+/g,'<br/>'
                           ).replace(
                            /^\<br\/\>/g, ''
                            ).replace(
                            ;
                            */
               },
               width : 220,
               xns : Roo.grid,
               '|xns' : 'Roo.grid'
              }
             ]
            }
           }
          ]
         }
        }
       ]
      }
     },
     {
      xtype : 'NestedLayoutPanel',
      autoScroll : false,
      fitContainer : true,
      fitToFrame : true,
      region : 'center',
      xns : Roo,
      '|xns' : 'Roo',
      toolbar : {
       xtype : 'Toolbar',
       xns : Roo,
       '|xns' : 'Roo',
       items  : [
        {
         xtype : 'Button',
         text : _this._strings['31fde7b05ac8952dacf4af8a704074ec'] /* Preview */,
         listeners : {
          click : function()
           {
               //_this.dialog.hide();
               Roo.log(_this.data.module);
               Pman.Dialog.CoreEmailPreview.show({ id : _this.form.findField('id').getValue(), module : _this.data.module });
           },
          render : function (_self)
           {
               _this.preview_btn = _self;
           }
         },
         xns : Roo.Toolbar,
         '|xns' : 'Roo.Toolbar'
        },
        {
         xtype : 'Button',
         text : _this._strings['5b8ef4e762c00a15a41cfc26dc3ef99c'] /* Send me a test copy */,
         listeners : {
          click : function()
           {
               //_this.dialog.hide();
           
               var id = _this.form.findField('id').getValue();
               
               if(id*1 < 1){
                   Roo.MessageBox.alert('Error', 'Please save the message frist!');
                   return;
               }
              
               new Pman.Request({
                   url : baseURL + '/Core/MessagePreview',
                   method : 'POST',
                   mask: 'Sending',
                   params : {
                       _id : id,
                       _table : _this.data.module
                   }, 
                   success : function(res) { 
                       if(res.data == 'SUCCESS'){
                           Roo.MessageBox.alert("Email Sent", 'The report was sent to your email (HTML format).');
                       }
                   }
               });
           },
          render : function (_self)
           {
               _this.html_preview = _self;
           }
         },
         xns : Roo.Toolbar,
         '|xns' : 'Roo.Toolbar'
        },
        {
         xtype : 'Button',
         text : _this._strings['f3017f202748e13d3554a15cbbd1b767'] /* Refresh from Stripo */,
         listeners : {
          click : function (_self, e)
           {
               var deleteImages = function() {
                   new Pman.Request({
                       url: baseURL + '/Roo/crm_mailing_list_message',
                       method: 'POST',
                       params : {
                           _delete_images: _this.form.findField('id').getValue()
                       },
                       mask : 'loading ...'
                   });
               };
               
               var updateSubjectAndName = function() {
                   new Pman.Request({
                       url: baseURL + '/Crm/Stripo',
                       method: 'GET',
                       mask: 'loading ...',
                       success: function(res) {
                           Roo.each(res.data, function(email) {
                               if(email.emailId == _this.form.findField('stripo_id').getValue()) {
                                   _this.form.findField('subject').setValue(email.title);
                                   _this.form.findField('name').setValue((new Date(email.updatedTime)).format('d M y') + ' - ' + email.title);
                               }
                           });
                           deleteImages();
                       }
                   });
               };
               
               var updatePlainText = function(bodytext) {
                   new Pman.Request({
                       url : baseURL + '/Core/ImportMailMessage.php',
                       method : 'POST',
                       params : {
                         bodytext : bodytext,
                         _convertToPlain : true,
                         _check_unsubscribe : true
                       },
                       mask : 'loading ...',
                       success : function(res) {
                           if(res.success == true){
                               _this.form.findField('plaintext').setValue(res.data);
                               updateSubjectAndName();
                           }
                       }
                   }); 
               };
               
               var updateBodyText = function() {
                   new Pman.Request({
                       url : baseURL + '/Crm/Stripo',
                       method : 'GET',
                       params : {
                           emailId: _this.form.findField('stripo_id').getValue()
                       },
                       mask : 'loading ...',
                       success : function(res) {
                           _this.form.findField('bodytext').setValue(res.data);
                           updatePlainText(res.data);
                       }
                   });
               };
               
               updateBodyText();
           },
          render : function (_self)
           {
               _this.stripoUpdate = this;
           }
         },
         xns : Roo.Toolbar,
         '|xns' : 'Roo.Toolbar'
        },
        {
         xtype : 'Fill',
         xns : Roo.Toolbar,
         '|xns' : 'Roo.Toolbar'
        },
        {
         xtype : 'Button',
         text : _this._strings['ea30b40c3caf28acb29198d20d243e54'] /* Images / Attachments >> */,
         listeners : {
          click : function (_self, e)
           {
               var el = _this.dialog.layout.getRegion('east');
               if (el.visible) {
                   el.hide();
               } else {
                   el.show();
                   el.showPanel(0);
               }
               
           }
         },
         xns : Roo.Toolbar,
         '|xns' : 'Roo.Toolbar'
        }
       ]
      },
      layout : {
       xtype : 'BorderLayout',
       xns : Roo,
       '|xns' : 'Roo',
       center : {
        xtype : 'LayoutRegion',
        autoScroll : true,
        xns : Roo,
        '|xns' : 'Roo'
       },
       items  : [
        {
         xtype : 'ContentPanel',
         autoScroll : false,
         background : false,
         fitContainer : true,
         fitToFrame : true,
         region : 'center',
         title : _this._strings['4c2a8fe7eaf24721cc7a9f0175115bd4'] /* Message */,
         listeners : {
          render : function (_self, width, height)
           {
               
                 Roo.log("RESIZE, " + width + ',' + height);
               
               var ew = Math.max(250, width-50);
               var eh = Math.max(250,height-50) ;
               
              
           
           },
          resize : function (_self, width, height)
           {
              var ew = Math.max(250, width-50);
               var eh = Math.max(250,height-50) ;
               
               if (!_this.form) {
                   return;
               }
               var bdtext = _this.form.findField('bodytext');
               var ptext = _this.form.findField('plaintext');
               if(bdtext.resizeEl){
                   bdtext.width = ew-50;
                   bdtext.resizeEl.resizeTo.defer(110, bdtext.resizeEl,[ bdtext.width, bdtext.height  ] );
                   ptext.setSize(bdtext.width , bdtext.height);
               }
           
           }
         },
         xns : Roo,
         '|xns' : 'Roo',
         items  : [
          {
           xtype : 'Form',
           labelAlign : 'right',
           labelWidth : 120,
           method : 'POST',
           preValidate : function(done_callback) {
               var fromValues = _this.form.getValues();
               _this.form.findField('from_email').setValue(typeof(Pman.Mail) == 'undefined' ? 
                   fromValues.from_email_text : 
                   fromValues.from_email_combo
               );
               
               Roo.MessageBox.progress("Uploading Images", "Uploading");
               
               if(!_this.form.findField('bodytext').editorcore.sourceEditMode){
                   _this.form.findField('bodytext').syncValue();
               }else{
                   _this.form.findField('bodytext').pushValue();
               }
               
               var html = _this.form.findField('bodytext').getValue();
               
               var s = Roo.get(_this.form.findField('bodytext').editorcore.doc.documentElement);
               
               var ontable = (_this.data.module) ? _this.data.module : 'crm_mailing_list_message';
               
               var nodes = [];
               s.select('img[src]').each(function(i) {
                   nodes.push(i.dom);
               });
               var total = nodes.length;
               var mkimg = function() {
               
                   if (!nodes.length) {
                         Roo.MessageBox.hide();
                         _this.form.findField('bodytext').syncValue();
                         done_callback(true);
                      //    _this.form.doAction("submit");
                         return;
                   }
                   var i = nodes.pop(); 
                   
                   var n = i.getAttribute('src').match(/(baseURL|server_baseurl)/);
                   
                   if(n){
                       mkimg();
                       return;
                   }
                   
                   n = i.getAttribute('src').match(/^http(.*)/);
                  
                   if(!n ){
                       mkimg();
                       return;
                   }
                   
                   new Pman.Request({
                       url : baseURL + '/Roo/Images.php',
                       method : 'POST',
                       params : {
                           onid : _this.form.findField('id').getValue(),
                           ontable : ontable ,
                           _remote_upload : i.src
                       },
                       success : function(res){
                           if(res.success == true){      
                               i.setAttribute('src', res.data);
                               Roo.MessageBox.updateProgress( (total - nodes.length) / total , "Done " + (total - nodes.length) + '/' + total);
                           }
                           mkimg();
                       }
                   });
                  
               }
               
               if (!_this.form.findField('bodytext').getValue().match(/unsubscribe/i)) {
                   Roo.MessageBox.confirm("Missing unusubscribe",
                       "There is no unsubscribe link on the email  are you sure you want to save it",
                       function(res) {
                           if (res == 'no') {
                               return;
                           }
                           mkimg();
                       }
                   );
           
                   return;
               }
               
               mkimg();
           },
           style : 'margin:10px',
           url : baseURL + '/Roo/crm_mailing_list_message.php',
           listeners : {
            actioncomplete : function(_self,action)
             {
                
                 if (action.type == 'setdata') {
                 
                     var bt = _this.form.findField('bodytext');
                     bt.autosave.defer(5000,bt);
                     
                     _this.data.module = _this.data.module || 'crm_mailing_list_message';
                     
                     _this.form.url = baseURL + '/Roo/' + _this.data.module;
                     
                     _this.html_preview.hide();
                     _this.preview_btn.hide();
                     _this.stripoUpdate.hide();
                     _this.sendBtn.hide();
                     _this.sendTestBtn.hide();
                     
                     
                       if (typeof(_this.data._fields) != 'undefined') {
                           _this.unsubscribeselect.store.proxy.data = _this.data._fields;
                       }
                     
                     
                     if(typeof(_this.data.module) != 'undefined' && _this.data.module == 'crm_mailing_list_message') {
                         _this.sendTestBtn.show();
                     }
                         
                     if(_this.data.id*1 > 0){
                         _this.dialog.el.mask("Loading");
                         this.load({ method: 'GET', params: { '_id' : _this.data.id }});
                         _this.html_preview.show();
                         _this.preview_btn.show();
                         
                     } else {
                         _this.form.setValues({
                             'from_name' : Pman.Login.authUser.name,
                             'from_email' : Pman.Login.authUser.email,
                             'language': Pman.Login.authUser.lang == '' ? 'en' : Pman.Login.authUser.lang
                         });
                         
                         _this.form.findField('from_email_text').setValue(_this.form.findField('from_email').getValue());
                         
                         
                         if(typeof(Pman.Mail) != 'undefined') {
                             Pman.Request({
                                 url: baseURL + '/Roo/Mail_imap_user.php',
                                 method: 'GET',
                                 params: {
                                     _email_senders: 1
                                 },
                                 success: function(res) {
                                     if(!res.data.length) {
                                         return;
                                     }
                                     _this.form.setValues({
                                         'from_name' : res.data[0].name,
                                         'from_email' : res.data[0].email
                                     });
                                     _this.form.findField('from_email_combo').setValue(_this.form.findField('from_email').getValue());
                                 }
                             });
                         }
                     }
                    return;
                 }
                 if (action.type == 'load') {
                     _this.dialog.el.unmask();
                     _this.saveBtn.setText('Save & Close');
                     
                     _this.form.findField('bodytext').originalValue = _this.form.findField('bodytext').getValue();
                     
                     var emailField = typeof(Pman.Mail) == 'undefined' ? 'from_email_text' : 'from_email_combo';
                     _this.form.findField(emailField).setValue(_this.form.findField('from_email').getValue());
                     
                     if(typeof(_this.data.module) != 'undefined' && _this.data.module == 'crm_mailing_list_message') {
                         if(_this.form.findField('stripo_id').getValue() > 0) {
                             _this.stripoUpdate.show();
                         }
                         _this.sendBtn.show();
                         _this.sendTestBtn.show();
                     }
                     
                     return;
                 }
                 if (action.type =='submit') {
                     var module = _this.data.module;
                 
                     _this.dialog.el.unmask();
                     _this.data = action.result.data;
                     
                     if (_this.form.findField('id').getValue() * 1 < 1) {
                         _this.form.findField('id').setValue(action.result.data.id);
                         _this.saveBtn.setText('Save & Close');
                         
                         if(typeof(module) != 'undefined' && module == 'crm_mailing_list_message') {
                             _this.html_preview.show();
                             _this.preview_btn.show();
                             
                             if(_this.form.findField('stripo_id').getValue() > 0) {
                                 _this.stripoUpdate.show();
                             }
                             _this.sendBtn.show();
                         }
                         
                         if(typeof(_this.sendTest) == 'undefined' || _this.sendTest !== true) {
                             return;
                         }
                     }
                     
                     _this.dialog.hide();
                      if (_this.callback) {
                         _this.callback.call(_this, action.result.data);
                      }
                      
                      if(typeof(_this.saveAndSend) != 'undefined' && _this.saveAndSend === true) {
                         _this.saveAndSend = false;
                         Pman.Dialog.CrmMailingListQueue.show( {
                             id : 0,
                             message_id : _this.form.findField('id').getValue(),
                             message_id_name : _this.form.findField('name').getValue()
                         }, function() {
                             // change the tab to queue...
                             var i = Pman.Tab.Crm.layout.getRegion('center').panels.indexOf(Pman.Tab.Crm.layout.getRegion('center').getActivePanel());
                             Pman.Tab.Crm.layout.getRegion('center').showPanel(i + 1);
                         });
                      }
                      
                      if(typeof(_this.sendTest) != 'undefined' && _this.sendTest == true) {
                         _this.sendTest = false;
                         Pman.Dialog.CrmMailingListQueue.show( {
                             id : 0,
                             message_id : _this.form.findField('id').getValue(),
                             message_id_name : _this.form.findField('name').getValue(),
                             _send_test: 1
                         }, function() {
                             // change the tab to queue...
                             var i = Pman.Tab.Crm.layout.getRegion('center').panels.indexOf(Pman.Tab.Crm.layout.getRegion('center').getActivePanel());
                             Pman.Tab.Crm.layout.getRegion('center').showPanel(i + 1);
                         });
                     }
                      _this.form.reset();
                      return;
                 }
             },
            rendered : function (form)
             {
                 _this.form= form;
             }
           },
           xns : Roo.form,
           '|xns' : 'Roo.form',
           items  : [
            {
             xtype : 'Row',
             xns : Roo.form,
             '|xns' : 'Roo.form',
             items  : [
              {
               xtype : 'TextField',
               allowBlank : false,
               fieldLabel : _this._strings['b20a8b77b05d53b4e695738731400c85'] /* Mailout Name */,
               name : 'name',
               width : 400,
               xns : Roo.form,
               '|xns' : 'Roo.form'
              },
              {
               xtype : 'Column',
               labelSeparator : ' ',
               labelWidth : 0,
               xns : Roo.form,
               '|xns' : 'Roo.form',
               items  : [
                {
                 xtype : 'Checkbox',
                 boxLabel : _this._strings['28690be026c0bb9003aa58e45e5662ca'] /* Enabled - will be sent out */,
                 checked : true,
                 name : 'active',
                 value : 1,
                 valueOff : 0,
                 listeners : {
                  check : function (_self, checked)
                   {
                       var boxLabel = 'Enabled - will be sent out';
                       
                       if(!checked){
                           boxLabel = 'Disabled - will NOT be sent out';
                       }
                       
                       this.setBoxLabel(boxLabel);
                   }
                 },
                 xns : Roo.form,
                 '|xns' : 'Roo.form'
                }
               ]
              }
             ]
            },
            {
             xtype : 'Row',
             xns : Roo.form,
             '|xns' : 'Roo.form',
             items  : [
              {
               xtype : 'TextField',
               allowBlank : false,
               fieldLabel : _this._strings['5da618e8e4b89c66fe86e32cdafde142'] /* From */,
               name : 'from_name',
               width : 300,
               xns : Roo.form,
               '|xns' : 'Roo.form'
              },
              {
               xtype : 'TextField',
               actionMode : 'fieldEl',
               allowBlank : true,
               fieldLabel : _this._strings['b357b524e740bc85b9790a0712d84a30'] /* Email address */,
               name : 'from_email_text',
               width : 300,
               listeners : {
                render : function (_self)
                 {
                     if(typeof(Pman.Mail) != 'undefined') {
                         _self.hide();
                     }
                 }
               },
               xns : Roo.form,
               '|xns' : 'Roo.form'
              },
              {
               xtype : 'ComboBox',
               allowBlank : true,
               alwaysQuery : true,
               displayField : 'email',
               editable : true,
               emptyText : _this._strings['8a10310fb61d63d1711b319163eff1b1'] /* Select email */,
               fieldLabel : _this._strings['b357b524e740bc85b9790a0712d84a30'] /* Email address */,
               forceSelection : true,
               listWidth : 300,
               loadingText : _this._strings['1243daf593fa297e07ab03bf06d925af'] /* Searching... */,
               minChars : 1,
               name : 'from_email_combo',
               pageSize : 20,
               qtip : _this._strings['ce8ae9da5b7cd6c3df2929543a9af92d'] /* Email */,
               queryParam : 'search[email]',
               selectOnFocus : true,
               tpl : '<div class=\"x-grid-cell-text x-btn button\"><b>{name}</b> {email}</div>',
               triggerAction : 'all',
               typeAhead : false,
               valueField : 'id',
               width : 300,
               listeners : {
                render : function (_self)
                 {
                     if(typeof(Pman.Mail) == 'undefined') {
                         _self.hide();
                     }
                 },
                select : function (combo, record, index)
                 {
                     _this.form.findField('from_name').setValue(record.data.name);
                 }
               },
               xns : Roo.form,
               '|xns' : 'Roo.form',
               store : {
                xtype : 'Store',
                remoteSort : true,
                sortInfo : { direction : 'ASC', field: 'email' },
                listeners : {
                 beforeload : function (_self, o){
                      o.params = o.params || {};
                      o.params._email_senders = 1;
                     o.params['_multisort'] = JSON.stringify(
                         { sort : { 'is_public' : 'DESC', 'name': 'ASC' }, order : [ 'is_public', 'name' ]}
                     );
                  }
                },
                xns : Roo.data,
                '|xns' : 'Roo.data',
                proxy : {
                 xtype : 'HttpProxy',
                 method : 'GET',
                 url : baseURL + '/Roo/mail_imap_user',
                 xns : Roo.data,
                 '|xns' : 'Roo.data'
                },
                reader : {
                 xtype : 'JsonReader',
                 id : 'id',
                 root : 'data',
                 totalProperty : 'total',
                 xns : Roo.data,
                 '|xns' : 'Roo.data'
                }
               }
              },
              {
               xtype : 'ComboBox',
               allowBlank : true,
               alwaysQuery : true,
               displayField : 'name',
               editable : false,
               emptyText : _this._strings['2c466a2c159463f1d9ef5a7b57b52827'] /* Select BCC Group */,
               fieldLabel : _this._strings['68b00d723d37122f64da8d9939f836f0'] /* BCC Group */,
               forceSelection : true,
               hiddenName : 'bcc_group_id',
               loadingText : _this._strings['1243daf593fa297e07ab03bf06d925af'] /* Searching... */,
               minChars : 2,
               name : 'bcc_group_id_name',
               pageSize : 25,
               qtip : _this._strings['2c466a2c159463f1d9ef5a7b57b52827'] /* Select BCC Group */,
               selectOnFocus : true,
               tpl : '<div class=\"x-grid-cell-text x-btn button\"><b>{name}</b> </div>',
               triggerAction : 'all',
               typeAhead : true,
               valueField : 'id',
               width : 300,
               xns : Roo.form,
               '|xns' : 'Roo.form',
               store : {
                xtype : 'Store',
                remoteSort : true,
                sortInfo : { direction : 'ASC', field: 'name' },
                listeners : {
                 beforeload : function (_self, o){
                      o.params = o.params || {};
                      
                      o.params._direct_return = 1;
                  }
                },
                xns : Roo.data,
                '|xns' : 'Roo.data',
                proxy : {
                 xtype : 'HttpProxy',
                 method : 'GET',
                 url : baseURL + '/Roo/Core_group',
                 xns : Roo.data,
                 '|xns' : 'Roo.data'
                },
                reader : {
                 xtype : 'JsonReader',
                 fields : [{"name":"name","type":"string"},{"name":"id","type":"int"}],
                 id : 'name',
                 root : 'data',
                 totalProperty : 'total',
                 xns : Roo.data,
                 '|xns' : 'Roo.data'
                }
               }
              }
             ]
            },
            {
             xtype : 'Row',
             xns : Roo.form,
             '|xns' : 'Roo.form',
             items  : [
              {
               xtype : 'TextField',
               allowBlank : false,
               fieldLabel : _this._strings['c7892ebbb139886662c6f2fc8c450710'] /* Subject */,
               name : 'subject',
               width : 600,
               xns : Roo.form,
               '|xns' : 'Roo.form'
              },
              {
               xtype : 'ComboBox',
               allowBlank : false,
               displayField : 'title',
               editable : false,
               fieldLabel : _this._strings['4994a8ffeba4ac3140beb89e8d41f174'] /* Language */,
               hiddenName : 'language',
               listWidth : 200,
               mode : 'local',
               name : 'language_name',
               tpl : '<div class=\"x-grid-cell-text x-btn button\"><b>{title}</b> </div>',
               triggerAction : 'all',
               valueField : 'code',
               width : 200,
               xns : Roo.form,
               '|xns' : 'Roo.form',
               store : {
                xtype : 'SimpleStore',
                data : (function() {return typeof(Pman) == 'object'  ? Pman.I18n.simpleStoreData('l') : []})(),
                fields : ['code', 'title'],
                xns : Roo.data,
                '|xns' : 'Roo.data'
               }
              }
             ]
            },
            {
             xtype : 'Row',
             hideLabels : true,
             xns : Roo.form,
             '|xns' : 'Roo.form',
             items  : [
              {
               xtype : 'FieldSet',
               hideLabels : true,
               legend : _this._strings['962b90039a542a29cedd51d87a9f28a1'] /* Html Editor */,
               style : 'text-align:center;',
               xns : Roo.form,
               '|xns' : 'Roo.form',
               items  : [
                {
                 xtype : 'HtmlEditor',
                 allowComments : true,
                 autoClean : false,
                 autosave : function() {
                     
                     var body = _this.form.findField('bodytext');
                     
                     if(!body.wrap.isVisible(true) || body.getValue() == '' || !body.isDirty()){
                         Roo.log('body not dirty');
                         return;
                     }
                     
                     Roo.log('body dirty, auto save!');
                     
                     body.fireEvent('autosave', body);
                    
                 },
                 clearUp : false,
                 cwhite : [ 
                     'background',
                     'background-color',
                     'border',
                     'border-radius',
                     'border-bottom',
                     'border-left',
                     'border-right',
                     'border-top',
                     'border-collapse',
                      'border-color',
                      'border-style',
                     'border-width',
                 
                     
                     'box-shadow',
                     'clear',
                     'color',
                     'cursor',
                     'display',
                     'float' ,
                     'font-family',
                     'font-size',
                     'font-style',        
                     'font-weight',
                 
                     'height',
                     'left',
                     'line-height',
                     'list-style',
                     'margin',
                     'margin-bottom',
                     'margin-left',
                     'margin-right',
                     'margin-top',
                     'max-width',
                     'min-height',
                     '-ms-interpolation-mode',
                     'mso-table-rspace',
                     '-ms-text-size-adjust',
                     'outline',
                     'overflow',
                     'padding',
                     'padding-bottom',
                     'padding-left',
                     'padding-right',
                     'padding-top',
                     'position',
                     'right',
                     'text-align',
                     'text-decoration',
                     'top',
                     'vertical-align',
                     '-webkit-text-size-adjust',
                     'width',
                     'width',
                     'z-index'
                  ],
                 enableBlocks : false,
                 height : 250,
                 name : 'bodytext',
                 resizable : 's',
                 listeners : {
                  autosave : function (_self)
                   {
                       Roo.log('autosave');
                       
                       var id = _this.form.findField('id').getValue() * 1;
                       
                       /*
                       if(!_self.editorcore.sourceEditMode){
                           _self.syncValue();
                       }else{
                           _self.pushValue();
                       }
                       */
                   
                       
                       new Pman.Request({
                           url : baseURL + '/Roo/Events.php',
                           method :'POST',
                           params : {
                               id : 0,
                               action : 'AUTOSAVE',
                               on_id : (id > 0) ? id : 0,
                               on_table : 'crm_mailing_list_message',
                               remarks : 'BODY',
                               source: _self.getValue()
                           },
                           success : function() {
                               _self.originalValue = _self.getValue();
                               if (_this.dialog.isVisible()) {
                                   _self.autosave.defer(5000, _self);
                               }
                               
                               
                           },
                           failure : function() 
                           {
                               Roo.log('body autosave failed?!');
                               // try again.
                               if (_this.dialog.isVisible()) {
                                   _self.autosave.defer(5000, _self);
                               }
                           }
                       });
                       
                   },
                  savedpreview : function (_self)
                   {
                       var id = _this.form.findField('id').getValue() * 1;
                       
                       var successFn = function(res){
                           return res.data.POST.source;
                       };
                       
                       var params = {
                           action : 'AUTOSAVE',
                           remarks : 'BODY',
                           on_id : (id < 1) ? 0 : id,
                           on_table : 'crm_mailing_list_message',
                           successFn : successFn
                       };
                       
                       
                       Pman.Dialog.CoreAutoSavePreview.show(params, function(res){
                           _self.setValue(res);
                           _self.originalValue = res;
                       });
                   }
                 },
                 xns : Roo.form,
                 '|xns' : 'Roo.form',
                 toolbars : [
                  {
                   xtype : 'ToolbarContext',
                   xns : Roo.form.HtmlEditor,
                   '|xns' : 'Roo.form.HtmlEditor'
                  },
                  {
                   xtype : 'ToolbarStandard',
                   xns : Roo.form.HtmlEditor,
                   '|xns' : 'Roo.form.HtmlEditor',
                   btns : [
                    {
                     xtype : 'ComboBox',
                     alwaysQuery : true,
                     displayField : 'name',
                     editable : false,
                     emptyText : _this._strings['b9c49611cfda3259a2b837b39489e650'] /* Add Image */,
                     fieldLabel : _this._strings['fff0d600f8a0b5e19e88bfb821dd1157'] /* Images */,
                     forceSelection : true,
                     listWidth : 400,
                     loadingText : _this._strings['1243daf593fa297e07ab03bf06d925af'] /* Searching... */,
                     minChars : 2,
                     pageSize : 20,
                     qtip : _this._strings['2f26e35d61be90501e099089dc533638'] /* Select Images */,
                     selectOnFocus : true,
                     tpl : '<div class=\"x-grid-cell-text x-btn button\"><img src=\"{public_baseURL}/Core/Images/Thumb/150x150/{id}.jpg\" height=\"150\" width=\"150\"><b>{filename}</b> </div>',
                     triggerAction : 'all',
                     typeAhead : true,
                     valueField : 'id',
                     width : 100,
                     listeners : {
                      beforequery : function (combo, query, forceAll, cancel, e)
                       {
                           var id = _this.form.findField('id').getValue() * 1;    
                           if (!id) {
                               Roo.MessageBox.alert("Error", "Save message first");
                               return false;
                           }
                       },
                      render : function (_self)
                       {
                           _this.extendimgselect = _self;
                       },
                      select : function (combo, record, index)
                       {
                           Roo.log(record);
                           (function() { 
                               combo.setValue('');
                           }).defer(100);
                           var editor = _this.form.findField('bodytext').editorcore;
                           
                           var curnode = editor.getSelectedNode();
                           if (curnode && curnode.tagName == 'IMG') {
                               curnode.src= String.format('{0}/Images/{1}/{2}#image-{1}',
                                       baseURL,  record.data.id, record.data.filename
                                   );
                                   // note -forces an update... hopefully...
                               editor.owner.fireEvent('editorevent', editor, false);
                           } else {
                           
                               editor.insertAtCursor(
                                   String.format('<img src="{0}/Images/{1}/{2}#image-{1}">',
                                   baseURL,  record.data.id, record.data.filename
                                   )
                               );
                       
                           }
                           
                        }
                     },
                     xns : Roo.form,
                     '|xns' : 'Roo.form',
                     store : {
                      xtype : 'Store',
                      remoteSort : true,
                      sortInfo : { direction : 'ASC', field: 'id' },
                      listeners : {
                       beforeload : function (_self, o){
                            o.params = o.params || {};
                        
                            var id = _this.form.findField('id').getValue() * 1;    
                            if (!id) {
                                Roo.MessageBox.alert("Error", "Save email template first");
                                return false;
                            }
                            o.params.onid = id;
                            o.params.ontable = (_this.data.module) ? _this.data.module : 'crm_mailing_list_message';
                            
                           // o.params.imgtype = 'PressRelease';
                            //o.params['query[imagesize]'] = '150x150';
                            // set more here
                        }
                      },
                      xns : Roo.data,
                      '|xns' : 'Roo.data',
                      proxy : {
                       xtype : 'HttpProxy',
                       method : 'GET',
                       url : baseURL + '/Roo/Images.php',
                       xns : Roo.data,
                       '|xns' : 'Roo.data'
                      },
                      reader : {
                       xtype : 'JsonReader',
                       fields : [{"name":"id","type":"int"},{"name":"filename","type":"string"},{"name":"url_thumb","type":"string"}],
                       id : 'id',
                       root : 'data',
                       totalProperty : 'total',
                       xns : Roo.data,
                       '|xns' : 'Roo.data'
                      }
                     }
                    },
                    {
                     xtype : 'ComboBox',
                     alwaysQuery : true,
                     displayField : 'name',
                     editable : false,
                     emptyText : _this._strings['5feb9bf3c03b32635135006cbacb9542'] /* Insert Field */,
                     fieldLabel : _this._strings['6f16a5f8ff5d75ab84c018adacdfcbb7'] /* Field */,
                     forceSelection : true,
                     listWidth : 400,
                     loadingText : _this._strings['1243daf593fa297e07ab03bf06d925af'] /* Searching... */,
                     minChars : 2,
                     pageSize : 20,
                     qtip : _this._strings['5feb9bf3c03b32635135006cbacb9542'] /* Insert Field */,
                     selectOnFocus : true,
                     tpl : '<div class=\"x-grid-cell-text x-btn button\"><b>{name}</b> </div>',
                     triggerAction : 'all',
                     typeAhead : true,
                     valueField : 'type',
                     width : 100,
                     listeners : {
                      render : function (_self)
                       {
                           _this.unsubscribeselect = _self;
                       },
                      select : function (combo, record, index)
                       {
                           Roo.log(record);
                           (function() { 
                               combo.setValue('');
                           }).defer(100);
                           var editor = _this.form.findField('bodytext').editorcore;
                           
                           if(record.data.name == 'Unsubscribe'){
                               editor.insertAtCursor(
                                   String.format('<a href="{0}">{1}</a>',
                                       record.data.type,  record.data.name
                                   )
                               );
                               return;     
                           }
                           
                           editor.insertAtCursor(
                               String.format('{0}',
                                   record.data.type
                               )
                           );
                           
                        }
                     },
                     xns : Roo.form,
                     '|xns' : 'Roo.form',
                     store : {
                      xtype : 'SimpleStore',
                      data : [ 
                          [ '{person.firstname}', "First Name"],
                          [ '{person.lastname}' , "Last Name"],
                          [ '{person.name}', "Full Name"],
                          [ '#unsubscribe', "Unsubscribe"]
                      ],
                      fields : [  'type', 'name'],
                      xns : Roo.data,
                      '|xns' : 'Roo.data'
                     }
                    },
                    {
                     xtype : 'Separator',
                     xns : Roo.Toolbar,
                     '|xns' : 'Roo.Toolbar'
                    },
                    {
                     xtype : 'Button',
                     cls : 'x-init-enable',
                     text : _this._strings['bd88a20b53a47f7b5704a83a15ff5506'] /* Saved Version */,
                     listeners : {
                      click : function (_self, e)
                       {
                           this.scope.owner.fireEvent('savedpreview', this.scope.owner);
                           
                       }
                     },
                     xns : Roo.Toolbar,
                     '|xns' : 'Roo.Toolbar'
                    }
                   ]
                  }
                 ]
                }
               ]
              }
             ]
            },
            {
             xtype : 'Row',
             hideLabels : true,
             xns : Roo.form,
             '|xns' : 'Roo.form',
             items  : [
              {
               xtype : 'Button',
               text : _this._strings['e9968623956c15023d54335ea3699855'] /* Convert Html to Text */,
               listeners : {
                click : function (_self, e)
                 {
                     var h = _this.form.findField('bodytext').getValue();
                     var p = _this.form.findField('plaintext');
                     
                     new Pman.Request({
                         url : baseURL + '/Core/ImportMailMessage.php',
                         method : 'POST',
                         params : {
                           bodytext : h,
                           _convertToPlain : true,
                           _check_unsubscribe : true
                         }, 
                         success : function(res) {
                             if(res.success == true){
                                p.setValue(res.data);
                             }
                         }
                     });
                     
                 }
               },
               xns : Roo,
               '|xns' : 'Roo'
              }
             ]
            },
            {
             xtype : 'Row',
             hideLabels : true,
             xns : Roo.form,
             '|xns' : 'Roo.form',
             items  : [
              {
               xtype : 'FieldSet',
               hideLabels : true,
               legend : _this._strings['e44b145bd8b49b06e0ad2ced1ad56466'] /* Plain Text */,
               style : 'text-align:center;',
               xns : Roo.form,
               '|xns' : 'Roo.form',
               items  : [
                {
                 xtype : 'TextArea',
                 height : 50,
                 name : 'plaintext',
                 xns : Roo.form,
                 '|xns' : 'Roo.form'
                }
               ]
              }
             ]
            },
            {
             xtype : 'Row',
             xns : Roo.form,
             '|xns' : 'Roo.form',
             items  : [
              {
               xtype : 'TextField',
               allowBlank : true,
               fieldLabel : _this._strings['b337c8a67244afb6551ee1f8f9717676'] /* Test Class <BR/> (for system reference only) */,
               name : 'test_class',
               readOnly : true,
               width : 300,
               xns : Roo.form,
               '|xns' : 'Roo.form'
              }
             ]
            },
            {
             xtype : 'Hidden',
             name : 'id',
             xns : Roo.form,
             '|xns' : 'Roo.form'
            },
            {
             xtype : 'Hidden',
             name : 'stripo_id',
             xns : Roo.form,
             '|xns' : 'Roo.form'
            },
            {
             xtype : 'Hidden',
             name : 'from_email',
             xns : Roo.form,
             '|xns' : 'Roo.form'
            }
           ]
          }
         ]
        }
       ]
      }
     },
     {
      xtype : 'GridPanel',
      background : true,
      fitContainer : true,
      fitToframe : true,
      region : 'center',
      tableName : 'Groups',
      title : _this._strings['16d2b386b2034b9488996466aaae0b57'] /* History */,
      listeners : {
       activate : function() {
            _this.mpanel = this;
            if (_this.mgrid) {
                _this.mgrid.footer.onClick('first');
            }
        }
      },
      xns : Roo,
      '|xns' : 'Roo',
      grid : {
       xtype : 'Grid',
       autoExpandColumn : 'event_id_remarks',
       loadMask : true,
       listeners : {
        celldblclick : function (_self, rowIndex, columnIndex, e)
         {
             var r = _self.ds.getAt(rowIndex);
             if(r.data.event_id) {
                 Pman.Dialog.CoreViewWebsite.show({url: baseURL + '/Admin/EventView/' + r.data.event_id + '.html'});
             }
             
         },
        render : function() 
         {
             _this.mgrid = this; 
             //_this.dialog = Pman.Dialog.FILL_IN
             if (_this.mpanel.active) {
                this.footer.onClick('first');
             }
         }
       },
       xns : Roo.grid,
       '|xns' : 'Roo.grid',
       footer : {
        xtype : 'PagingToolbar',
        displayInfo : true,
        displayMsg : _this._strings['b2902068bd468131aae5469000ead0f9'] /* Displaying Notifications{0} - {1} of {2} */,
        emptyMsg : _this._strings['318e5e65b99bb99f6ec676ac53045808'] /* No Notifications found */,
        pageSize : 25,
        xns : Roo,
        '|xns' : 'Roo'
       },
       toolbar : {
        xtype : 'Toolbar',
        xns : Roo,
        '|xns' : 'Roo',
        items  : [
         {
          xtype : 'Fill',
          xns : Roo.Toolbar,
          '|xns' : 'Roo.Toolbar'
         }
        ]
       },
       dataSource : {
        xtype : 'Store',
        remoteSort : true,
        sortInfo : { field : 'act_when', direction: 'DESC' },
        listeners : {
         beforeload : function (_self, options)
          {
              options.params = options.params || {};
              
              /*
              
              options.params.ontable = 'crm_mailing_list_queue';
              
              options.params.crm_person_id = _this.form.findField('id').getValue();
              options.params['query[status]'] = _this.status.getValue();
              */
          }
        },
        xns : Roo.data,
        '|xns' : 'Roo.data',
        proxy : {
         xtype : 'HttpProxy',
         method : 'GET',
         url : baseURL + '/Roo/Core_notify.php',
         xns : Roo.data,
         '|xns' : 'Roo.data'
        },
        reader : {
         xtype : 'JsonReader',
         fields : [
             {
                 'name': 'id',
                 'type': 'int'
             }
         ],
         id : 'id',
         root : 'data',
         totalProperty : 'total',
         xns : Roo.data,
         '|xns' : 'Roo.data'
        }
       },
       sm : {
        xtype : 'RowSelectionModel',
        singleSelect : true,
        xns : Roo.grid,
        '|xns' : 'Roo.grid'
       },
       colModel : [
        {
         xtype : 'ColumnModel',
         dataIndex : 'id',
         header : _this._strings['9c9745a343efeacc9efe9b7222b27afb'] /* Ref# */,
         renderer : function(v) 
         { 
             return String.format('{0}', v );
         },
         width : 50,
         xns : Roo.grid,
         '|xns' : 'Roo.grid'
        },
        {
         xtype : 'ColumnModel',
         dataIndex : 'sent',
         header : _this._strings['5b7d0fb4422f6d5854b9827293ece5ea'] /* Sent Date */,
         renderer : function(v) 
         { 
             return String.format('{0}', (v) ? v.format('d/M/Y h:ia') : '' );
         },
         width : 120,
         xns : Roo.grid,
         '|xns' : 'Roo.grid'
        },
        {
         xtype : 'ColumnModel',
         dataIndex : 'msgid',
         header : _this._strings['67edd3b99247c9eb5884a02802a20fa7'] /* Delivered */,
         renderer : function(v) { return String.format('{0}', v ? 'YES' : 'NO'); },
         width : 75,
         xns : Roo.grid,
         '|xns' : 'Roo.grid'
        },
        {
         xtype : 'ColumnModel',
         dataIndex : 'event_id_remarks',
         header : _this._strings['231bc72756b5e6de492aaaa1577f61b1'] /* Remarks */,
         renderer : function(v) { return String.format('<span qtip="{0}">{0}</span>', v ); },
         width : 200,
         xns : Roo.grid,
         '|xns' : 'Roo.grid'
        }
       ]
      }
     },
     {
      xtype : 'GridPanel',
      autoScroll : false,
      background : false,
      fitContainer : true,
      fitToframe : true,
      region : 'east',
      tableName : 'Images',
      title : _this._strings['308f2757bfc9ce92fb00ff93fdffd279'] /* Images / Attachments */,
      listeners : {
       activate : function() {
            _this.ipanel = this;
            if (_this.igrid) {
               _this.igrid.ds.load({});
            }
        }
      },
      xns : Roo,
      '|xns' : 'Roo',
      grid : {
       xtype : 'Grid',
       autoExpandColumn : 'filename',
       loadMask : true,
       listeners : {
        render : function() 
         {
             _this.igrid = this; 
             //_this.dialog = Pman.Dialog.FILL_IN
             if (_this.ipanel.active) {
            //    _this.igrid.ds.load({});
             }
         }
       },
       xns : Roo.grid,
       '|xns' : 'Roo.grid',
       toolbar : {
        xtype : 'Toolbar',
        xns : Roo,
        '|xns' : 'Roo',
        items  : [
         {
          xtype : 'Button',
          cls : 'x-btn-text-icon',
          icon : Roo.rootURL + 'images/default/dd/drop-add.gif',
          text : _this._strings['ec211f7c20af43e742bf2570c3cb84f9'] /* Add */,
          listeners : {
           click : function()
            {
                var id = _this.form.findField('id').getValue();
                
                if(id*1 < 1){
                    Roo.MessageBox.alert('Error', 'Please save the email template first');
                    return;
                }
                
                var ontable = (_this.data.module) ? _this.data.module : 'crm_mailing_list_message';
                
                Pman.Dialog.Image.show( { id : 0, onid: id, ontable: ontable }, function() {
                    _this.igrid.getDataSource().load({});
                });
            }
          },
          xns : Roo.Toolbar,
          '|xns' : 'Roo.Toolbar'
         },
         {
          xtype : 'Button',
          cls : 'x-btn-text-icon',
          icon : rootURL + '/Pman/templates/images/trash.gif',
          text : _this._strings['f2a6c498fb90ee345d997f888fce3b18'] /* Delete */,
          listeners : {
           click : function()
            {
                       Pman.genericDelete({grid: _this.igrid}, 'Images');
            }
          },
          xns : Roo.Toolbar,
          '|xns' : 'Roo.Toolbar'
         }
        ]
       },
       dataSource : {
        xtype : 'Store',
        remoteSort : true,
        sortInfo : { field : 'filename', direction: 'ASC' },
        listeners : {
         beforeload : function (_self, options)
          {
              options.params = options.params || {};
              if (typeof(_this.data) == 'undefined') {
                  return false;
              }
              if(_this.data.id * 1 >= 0)
              {
                  options.params.onid = _this.data.id;
          
                  options.params.ontable = (_this.data.module) ? _this.data.module : 'crm_mailing_list_message';
              }
          }
        },
        xns : Roo.data,
        '|xns' : 'Roo.data',
        proxy : {
         xtype : 'HttpProxy',
         method : 'GET',
         url : baseURL + '/Roo/Images.php',
         xns : Roo.data,
         '|xns' : 'Roo.data'
        },
        reader : {
         xtype : 'JsonReader',
         fields : [
             {
                 'name': 'id',
                 'type': 'int'
             },
             {
                 'name': 'filename',
                 'type': 'string'
             },
             {
                 'name': 'ontable',
                 'type': 'string'
             },
             {
                 'name': 'onid',
                 'type': 'int'
             },
             {
                 'name': 'mimetype',
                 'type': 'string'
             },
             {
                 'name': 'width',
                 'type': 'int'
             },
             {
                 'name': 'height',
                 'type': 'int'
             },
             {
                 'name': 'filesize',
                 'type': 'int'
             },
             {
                 'name': 'displayorder',
                 'type': 'int'
             },
             {
                 'name': 'language',
                 'type': 'string'
             },
             {
                 'name': 'parent_image_id',
                 'type': 'int'
             },
             {
                 'name': 'created',
                 'type': 'date',
                 'dateFormat': 'Y-m-d'
             },
             {
                 'name': 'imgtype',
                 'type': 'string'
             },
             {
                 'name': 'linkurl',
                 'type': 'string'
             },
             {
                 'name': 'descript',
                 'type': 'string'
             },
             {
                 'name': 'title',
                 'type': 'string'
             },
             {
                 'name': 'parent_image_id_id',
                 'type': 'int'
             },
             {
                 'name': 'parent_image_id_filename',
                 'type': 'string'
             },
             {
                 'name': 'parent_image_id_ontable',
                 'type': 'string'
             },
             {
                 'name': 'parent_image_id_onid',
                 'type': 'int'
             },
             {
                 'name': 'parent_image_id_mimetype',
                 'type': 'string'
             },
             {
                 'name': 'parent_image_id_width',
                 'type': 'int'
             },
             {
                 'name': 'parent_image_id_height',
                 'type': 'int'
             },
             {
                 'name': 'parent_image_id_filesize',
                 'type': 'int'
             },
             {
                 'name': 'parent_image_id_displayorder',
                 'type': 'int'
             },
             {
                 'name': 'parent_image_id_language',
                 'type': 'string'
             },
             {
                 'name': 'parent_image_id_parent_image_id',
                 'type': 'int'
             },
             {
                 'name': 'parent_image_id_created',
                 'type': 'date'
             },
             {
                 'name': 'parent_image_id_imgtype',
                 'type': 'string'
             },
             {
                 'name': 'parent_image_id_linkurl',
                 'type': 'string'
             },
             {
                 'name': 'parent_image_id_descript',
                 'type': 'string'
             },
             {
                 'name': 'parent_image_id_title',
                 'type': 'string'
             }
         ],
         id : 'id',
         root : 'data',
         totalProperty : 'total',
         xns : Roo.data,
         '|xns' : 'Roo.data'
        }
       },
       colModel : [
        {
         xtype : 'ColumnModel',
         dataIndex : 'filename',
         header : _this._strings['1351017ac6423911223bc19a8cb7c653'] /* Filename */,
         renderer : function(v,x,r)
         {
             var width = r.data.width;
             var height = r.data.height;
             
             if(width > 50){
                 height = Math.round(height * 50 / width);
                 width = 50;
             }
             
            return '<img src="' + baseURL + '/Images/' + r.data.id + '/' + r.data.filename + '" width="' + width + '" height="' + height + '" />';
         },
         width : 300,
         xns : Roo.grid,
         '|xns' : 'Roo.grid'
        },
        {
         xtype : 'ColumnModel',
         dataIndex : 'displayorder',
         header : _this._strings['2393ad754ba179442d85e415d1d5167c'] /* Displayorder */,
         renderer : function(v) { return String.format('{0}', v); },
         width : 75,
         xns : Roo.grid,
         '|xns' : 'Roo.grid'
        },
        {
         xtype : 'ColumnModel',
         dataIndex : 'title',
         header : _this._strings['b78a3223503896721cca1303f776159b'] /* Title */,
         renderer : function(v) { return String.format('{0}', v); },
         width : 75,
         xns : Roo.grid,
         '|xns' : 'Roo.grid'
        }
       ]
      }
     }
    ]
   });
 }
};
